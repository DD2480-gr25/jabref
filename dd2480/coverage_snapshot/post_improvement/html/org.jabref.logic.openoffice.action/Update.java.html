<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sv"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Update.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JabRef</a> &gt; <a href="index.source.html" class="el_package">org.jabref.logic.openoffice.action</a> &gt; <span class="el_source">Update.java</span></div><h1>Update.java</h1><pre class="source lang-java linenums">package org.jabref.logic.openoffice.action;

import java.util.List;

import org.jabref.logic.openoffice.frontend.OOFrontend;
import org.jabref.logic.openoffice.frontend.UpdateBibliography;
import org.jabref.logic.openoffice.frontend.UpdateCitationMarkers;
import org.jabref.logic.openoffice.style.OOBibStyle;
import org.jabref.logic.openoffice.style.OOProcess;
import org.jabref.model.database.BibDatabase;
import org.jabref.model.openoffice.rangesort.FunctionalTextViewCursor;
import org.jabref.model.openoffice.uno.CreationException;
import org.jabref.model.openoffice.uno.NoDocumentException;
import org.jabref.model.openoffice.uno.UnoScreenRefresh;

import com.sun.star.lang.WrappedTargetException;
import com.sun.star.text.XTextDocument;

/**
 * Update document: citation marks and bibliography
 */
public class Update {

    static final boolean USE_LOCK_CONTROLLERS = true;
    
    private Update() {
        /**/
    }

    /**
     * @return the list of unresolved citation keys
     */
    private static List&lt;String&gt; updateDocument(XTextDocument doc,
                                               OOFrontend frontend,
                                               List&lt;BibDatabase&gt; databases,
                                               OOBibStyle style,
                                               FunctionalTextViewCursor fcursor,
                                               boolean doUpdateBibliography,
                                               boolean alwaysAddCitedOnPages)
        throws
        CreationException,
        NoDocumentException,
        WrappedTargetException,
        com.sun.star.lang.IllegalArgumentException {

<span class="nc" id="L46">        frontend.imposeGlobalOrder(doc, fcursor);</span>
<span class="nc" id="L47">        OOProcess.produceCitationMarkers(frontend.citationGroups, databases, style);</span>

        try {
            if (USE_LOCK_CONTROLLERS) {
<span class="nc" id="L51">                UnoScreenRefresh.lockControllers(doc);</span>
            }

<span class="nc" id="L54">            UpdateCitationMarkers.applyNewCitationMarkers(doc, frontend, style);</span>

<span class="nc bnc" id="L56" title="All 2 branches missed.">            if (doUpdateBibliography) {</span>
<span class="nc" id="L57">                UpdateBibliography.rebuildBibTextSection(doc,</span>
                                                         frontend,
<span class="nc" id="L59">                                                         frontend.citationGroups.getBibliography().get(),</span>
                                                         style,
                                                         alwaysAddCitedOnPages);
            }

<span class="nc" id="L64">            return frontend.citationGroups.getUnresolvedKeys();</span>
        } finally {
<span class="nc bnc" id="L66" title="All 2 branches missed.">            if (USE_LOCK_CONTROLLERS &amp;&amp; UnoScreenRefresh.hasControllersLocked(doc)) {</span>
<span class="nc" id="L67">                UnoScreenRefresh.unlockControllers(doc);</span>
            }
        }
    }

    public static class SyncOptions {

        public final List&lt;BibDatabase&gt; databases;
        boolean updateBibliography;
        boolean alwaysAddCitedOnPages;

<span class="nc" id="L78">        public SyncOptions(List&lt;BibDatabase&gt; databases) {</span>
<span class="nc" id="L79">            this.databases = databases;</span>
<span class="nc" id="L80">            this.updateBibliography = false;</span>
<span class="nc" id="L81">            this.alwaysAddCitedOnPages = false;</span>
<span class="nc" id="L82">        }</span>

        public SyncOptions setUpdateBibliography(boolean value) {
<span class="nc" id="L85">            this.updateBibliography = value;</span>
<span class="nc" id="L86">            return this;</span>
        }

        public SyncOptions setAlwaysAddCitedOnPages(boolean value) {
<span class="nc" id="L90">            this.alwaysAddCitedOnPages = value;</span>
<span class="nc" id="L91">            return this;</span>
        }
    }

    public static List&lt;String&gt; synchronizeDocument(XTextDocument doc,
                                                   OOFrontend frontend,
                                                   OOBibStyle style,
                                                   FunctionalTextViewCursor fcursor,
                                                   SyncOptions syncOptions)
        throws
        CreationException,
        NoDocumentException,
        WrappedTargetException,
        com.sun.star.lang.IllegalArgumentException {

<span class="nc" id="L106">        return Update.updateDocument(doc,</span>
                                     frontend,
                                     syncOptions.databases,
                                     style,
                                     fcursor,
                                     syncOptions.updateBibliography,
                                     syncOptions.alwaysAddCitedOnPages);
    }

    /*
     * Reread document before sync
     */
    public static List&lt;String&gt; resyncDocument(XTextDocument doc,
                                              OOBibStyle style,
                                              FunctionalTextViewCursor fcursor,
                                              SyncOptions syncOptions)
        throws
        CreationException,
        NoDocumentException,
        WrappedTargetException,
        com.sun.star.lang.IllegalArgumentException {

<span class="nc" id="L128">        OOFrontend frontend = new OOFrontend(doc);</span>

<span class="nc" id="L130">        return Update.synchronizeDocument(doc, frontend, style, fcursor, syncOptions);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>