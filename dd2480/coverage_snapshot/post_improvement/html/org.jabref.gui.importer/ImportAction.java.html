<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sv"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ImportAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JabRef</a> &gt; <a href="index.source.html" class="el_package">org.jabref.gui.importer</a> &gt; <span class="el_source">ImportAction.java</span></div><h1>ImportAction.java</h1><pre class="source lang-java linenums">package org.jabref.gui.importer;

import java.io.IOException;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import org.jabref.gui.DialogService;
import org.jabref.gui.Globals;
import org.jabref.gui.JabRefFrame;
import org.jabref.gui.LibraryTab;
import org.jabref.gui.util.BackgroundTask;
import org.jabref.gui.util.DefaultTaskExecutor;
import org.jabref.gui.util.TaskExecutor;
import org.jabref.logic.JabRefException;
import org.jabref.logic.database.DatabaseMerger;
import org.jabref.logic.importer.ImportException;
import org.jabref.logic.importer.ImportFormatReader;
import org.jabref.logic.importer.Importer;
import org.jabref.logic.importer.ParserResult;
import org.jabref.logic.importer.fileformat.PdfGrobidImporter;
import org.jabref.logic.importer.fileformat.PdfMergeMetadataImporter;
import org.jabref.logic.l10n.Localization;
import org.jabref.logic.util.StandardFileType;
import org.jabref.logic.util.UpdateField;
import org.jabref.model.database.BibDatabase;
import org.jabref.model.util.FileHelper;
import org.jabref.preferences.PreferencesService;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class ImportAction {
// FixMe: Command pattern is broken, should extend SimpleCommand

<span class="nc" id="L38">    private static final Logger LOGGER = LoggerFactory.getLogger(ImportAction.class);</span>

    private final JabRefFrame frame;
    private final boolean openInNew;
    private final Optional&lt;Importer&gt; importer;
    private final DialogService dialogService;
    private Exception importError;
<span class="nc" id="L45">    private final TaskExecutor taskExecutor = Globals.TASK_EXECUTOR;</span>

    private final PreferencesService prefs;

<span class="nc" id="L49">    public ImportAction(JabRefFrame frame, boolean openInNew, Importer importer, PreferencesService prefs) {</span>
<span class="nc" id="L50">        this.importer = Optional.ofNullable(importer);</span>
<span class="nc" id="L51">        this.frame = frame;</span>
<span class="nc" id="L52">        this.dialogService = frame.getDialogService();</span>
<span class="nc" id="L53">        this.openInNew = openInNew;</span>
<span class="nc" id="L54">        this.prefs = prefs;</span>
<span class="nc" id="L55">    }</span>

    /**
     * Automatically imports the files given as arguments.
     *
     * @param filenames List of files to import
     */
    public void automatedImport(List&lt;String&gt; filenames) {
<span class="nc" id="L63">        List&lt;Path&gt; files = filenames.stream().map(Path::of).collect(Collectors.toList());</span>
<span class="nc" id="L64">        BackgroundTask&lt;ParserResult&gt; task = BackgroundTask.wrap(() -&gt; {</span>
<span class="nc" id="L65">            List&lt;ImportFormatReader.UnknownFormatImport&gt; imports = doImport(files);</span>
            // Ok, done. Then try to gather in all we have found. Since we might
            // have found
            // one or more bibtex results, it's best to gather them in a
            // BibDatabase.
<span class="nc" id="L70">            ParserResult bibtexResult = mergeImportResults(imports);</span>

            // TODO: show parserwarnings, if any (not here)
            // for (ImportFormatReader.UnknownFormatImport p : imports) {
            //    ParserResultWarningDialog.showParserResultWarningDialog(p.parserResult, frame);
            // }
<span class="nc bnc" id="L76" title="All 2 branches missed.">            if (bibtexResult.isEmpty()) {</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">                if (importError == null) {</span>
                    // TODO: No control flow using exceptions
<span class="nc" id="L79">                    throw new JabRefException(Localization.lang(&quot;No entries found. Please make sure you are using the correct import filter.&quot;));</span>
                } else {
<span class="nc" id="L81">                    throw importError;</span>
                }
            }

<span class="nc" id="L85">            return bibtexResult;</span>
        });

<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (openInNew) {</span>
<span class="nc" id="L89">            task.onSuccess(parserResult -&gt; {</span>
<span class="nc" id="L90">                frame.addTab(parserResult.getDatabaseContext(), true);</span>
<span class="nc" id="L91">                dialogService.notify(Localization.lang(&quot;Imported entries&quot;) + &quot;: &quot; + parserResult.getDatabase().getEntries().size());</span>
<span class="nc" id="L92">            })</span>
<span class="nc" id="L93">           .onFailure(ex-&gt; {</span>
<span class="nc" id="L94">               LOGGER.error(&quot;Error importing&quot;, ex);</span>
<span class="nc" id="L95">               dialogService.notify(Localization.lang(&quot;Error importing. See the error log for details.&quot;));</span>
<span class="nc" id="L96">           })</span>
<span class="nc" id="L97">           .executeWith(taskExecutor);</span>
        } else {
<span class="nc" id="L99">            final LibraryTab libraryTab = frame.getCurrentLibraryTab();</span>

<span class="nc" id="L101">            ImportEntriesDialog dialog = new ImportEntriesDialog(libraryTab.getBibDatabaseContext(), task);</span>
<span class="nc" id="L102">            dialog.setTitle(Localization.lang(&quot;Import&quot;));</span>
<span class="nc" id="L103">            dialogService.showCustomDialogAndWait(dialog);</span>
        }
<span class="nc" id="L105">    }</span>

    private boolean fileIsPdf(Path filename) {
<span class="nc" id="L108">        Optional&lt;String&gt; extension = FileHelper.getFileExtension(filename);</span>
<span class="nc bnc" id="L109" title="All 4 branches missed.">        return extension.isPresent() &amp;&amp; StandardFileType.PDF.getExtensions().contains(extension.get());</span>
    }

    private List&lt;ImportFormatReader.UnknownFormatImport&gt; doImport(List&lt;Path&gt; files) {
        // We import all files and collect their results:
<span class="nc" id="L114">        List&lt;ImportFormatReader.UnknownFormatImport&gt; imports = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">        for (Path filename : files) {</span>
            try {
<span class="nc bnc" id="L117" title="All 2 branches missed.">                if (importer.isEmpty()) {</span>
                    // Unknown format:
<span class="nc" id="L119">                    DefaultTaskExecutor.runAndWaitInJavaFXThread(() -&gt; {</span>
<span class="nc bnc" id="L120" title="All 4 branches missed.">                        if (fileIsPdf(filename) &amp;&amp; GrobidOptInDialogHelper.showAndWaitIfUserIsUndecided(frame.getDialogService(), prefs.getImporterPreferences())) {</span>
<span class="nc" id="L121">                            Globals.IMPORT_FORMAT_READER.resetImportFormats(prefs.getImporterPreferences(), prefs.getGeneralPreferences(), prefs.getImportFormatPreferences(), prefs.getXmpPreferences(), Globals.getFileUpdateMonitor());</span>
                        }
<span class="nc" id="L123">                        frame.getDialogService().notify(Localization.lang(&quot;Importing in unknown format&quot;) + &quot;...&quot;);</span>
<span class="nc" id="L124">                    });</span>
                    // This import method never throws an IOException:
<span class="nc" id="L126">                    imports.add(Globals.IMPORT_FORMAT_READER.importUnknownFormat(filename, Globals.getFileUpdateMonitor()));</span>
                } else {
<span class="nc" id="L128">                    DefaultTaskExecutor.runAndWaitInJavaFXThread(() -&gt; {</span>
<span class="nc bnc" id="L129" title="All 6 branches missed.">                        if (importer.get() instanceof PdfGrobidImporter || importer.get() instanceof PdfMergeMetadataImporter &amp;&amp; GrobidOptInDialogHelper.showAndWaitIfUserIsUndecided(frame.getDialogService(), prefs.getImporterPreferences())) {</span>
<span class="nc" id="L130">                                Globals.IMPORT_FORMAT_READER.resetImportFormats(prefs.getImporterPreferences(), prefs.getGeneralPreferences(), prefs.getImportFormatPreferences(), prefs.getXmpPreferences(), Globals.getFileUpdateMonitor());</span>
                        }
<span class="nc" id="L132">                        frame.getDialogService().notify(Localization.lang(&quot;Importing in %0 format&quot;, importer.get().getName()) + &quot;...&quot;);</span>
<span class="nc" id="L133">                    });</span>
                    // Specific importer:
<span class="nc" id="L135">                    ParserResult pr = importer.get().importDatabase(filename, prefs.getGeneralPreferences().getDefaultEncoding());</span>
<span class="nc" id="L136">                    imports.add(new ImportFormatReader.UnknownFormatImport(importer.get().getName(), pr));</span>
                }
<span class="nc" id="L138">            } catch (ImportException | IOException e) {</span>
                // This indicates that a specific importer was specified, and that
                // this importer has thrown an IOException. We store the exception,
                // so a relevant error message can be displayed.
<span class="nc" id="L142">                importError = e;</span>
<span class="nc" id="L143">            }</span>
<span class="nc" id="L144">        }</span>
<span class="nc" id="L145">        return imports;</span>
    }

    /**
     * TODO: Move this to logic package. Blocked by undo functionality.
     */
    private ParserResult mergeImportResults(List&lt;ImportFormatReader.UnknownFormatImport&gt; imports) {
<span class="nc" id="L152">        BibDatabase resultDatabase = new BibDatabase();</span>
<span class="nc" id="L153">        ParserResult result = new ParserResult(resultDatabase);</span>

<span class="nc bnc" id="L155" title="All 2 branches missed.">        for (ImportFormatReader.UnknownFormatImport importResult : imports) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">            if (importResult == null) {</span>
<span class="nc" id="L157">                continue;</span>
            }
<span class="nc" id="L159">            ParserResult parserResult = importResult.parserResult;</span>
<span class="nc" id="L160">            resultDatabase.insertEntries(parserResult.getDatabase().getEntries());</span>

<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (ImportFormatReader.BIBTEX_FORMAT.equals(importResult.format)) {</span>
                // additional treatment of BibTeX
<span class="nc" id="L164">                new DatabaseMerger(prefs.getKeywordDelimiter()).mergeMetaData(</span>
<span class="nc" id="L165">                        result.getMetaData(),</span>
<span class="nc" id="L166">                        parserResult.getMetaData(),</span>
<span class="nc" id="L167">                        importResult.parserResult.getPath().map(path -&gt; path.getFileName().toString()).orElse(&quot;unknown&quot;),</span>
<span class="nc" id="L168">                        parserResult.getDatabase().getEntries());</span>
            }
            // TODO: collect errors into ParserResult, because they are currently ignored (see caller of this method)
<span class="nc" id="L171">        }</span>

        // set timestamp and owner
<span class="nc" id="L174">        UpdateField.setAutomaticFields(resultDatabase.getEntries(), prefs.getOwnerPreferences(), prefs.getTimestampPreferences()); // set timestamp and owner</span>

<span class="nc" id="L176">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>