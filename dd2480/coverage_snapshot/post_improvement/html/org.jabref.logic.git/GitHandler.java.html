<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sv"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GitHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JabRef</a> &gt; <a href="index.source.html" class="el_package">org.jabref.logic.git</a> &gt; <span class="el_source">GitHandler.java</span></div><h1>GitHandler.java</h1><pre class="source lang-java linenums">package org.jabref.logic.git;

import java.io.File;
import java.io.IOException;
import java.net.URISyntaxException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.util.Optional;

import org.jabref.logic.util.io.FileUtil;

import org.eclipse.jgit.api.Git;
import org.eclipse.jgit.api.RmCommand;
import org.eclipse.jgit.api.Status;
import org.eclipse.jgit.api.errors.GitAPIException;
import org.eclipse.jgit.lib.Ref;
import org.eclipse.jgit.merge.MergeStrategy;
import org.eclipse.jgit.transport.CredentialsProvider;
import org.eclipse.jgit.transport.UsernamePasswordCredentialsProvider;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * This class handles the updating of the local and remote git repository that is located at the repository path
 * This provides an easy to use interface to manage a git repository
 */
public class GitHandler {
<span class="fc" id="L28">    static final Logger LOGGER = LoggerFactory.getLogger(GitHandler.class);</span>
    final Path repositoryPath;
    final File repositoryPathAsFile;
<span class="fc" id="L31">    String gitUsername = Optional.ofNullable(System.getenv(&quot;GIT_EMAIL&quot;)).orElse(&quot;&quot;);</span>
<span class="fc" id="L32">    String gitPassword = Optional.ofNullable(System.getenv(&quot;GIT_PW&quot;)).orElse(&quot;&quot;);</span>
<span class="fc" id="L33">    final CredentialsProvider credentialsProvider = new UsernamePasswordCredentialsProvider(gitUsername, gitPassword);</span>

    /**
     * Initialize the handler for the given repository
     *
     * @param repositoryPath The root of the initialized git repository
     */
<span class="fc" id="L40">    public GitHandler(Path repositoryPath) {</span>
<span class="fc" id="L41">        this.repositoryPath = repositoryPath;</span>
<span class="fc" id="L42">        this.repositoryPathAsFile = this.repositoryPath.toFile();</span>
<span class="pc bpc" id="L43" title="1 of 2 branches missed.">        if (!isGitRepository()) {</span>
            try {
<span class="fc" id="L45">                Git.init()</span>
<span class="fc" id="L46">                   .setDirectory(repositoryPathAsFile)</span>
<span class="fc" id="L47">                   .call();</span>
<span class="fc" id="L48">                try (Git git = Git.open(repositoryPathAsFile)) {</span>
<span class="fc" id="L49">                    git.commit()</span>
<span class="fc" id="L50">                       .setAllowEmpty(true)</span>
<span class="fc" id="L51">                       .setMessage(&quot;Initial commit&quot;)</span>
<span class="fc" id="L52">                       .call();</span>
                }
<span class="fc" id="L54">                setupGitIgnore();</span>
<span class="nc" id="L55">            } catch (GitAPIException | IOException e) {</span>
<span class="nc" id="L56">                LOGGER.error(&quot;Initialization failed&quot;);</span>
<span class="fc" id="L57">            }</span>
        }
<span class="fc" id="L59">    }</span>

    void setupGitIgnore() {
        try {
<span class="fc" id="L63">            Path gitignore = Path.of(repositoryPath.toString(), &quot;.gitignore&quot;);</span>
<span class="pc bpc" id="L64" title="1 of 2 branches missed.">            if (!Files.exists(gitignore)) {</span>
<span class="fc" id="L65">                FileUtil.copyFile(Path.of(this.getClass().getResource(&quot;git.gitignore&quot;).toURI()), gitignore, false);</span>
            }
<span class="nc" id="L67">        } catch (URISyntaxException e) {</span>
<span class="nc" id="L68">            LOGGER.error(&quot;Error occurred during copying of the gitignore file into the git repository.&quot;);</span>
<span class="fc" id="L69">        }</span>
<span class="fc" id="L70">    }</span>

    /**
     * Returns true if the given path points to a directory that is a git repository (contains a .git folder)
     */
    boolean isGitRepository() {
        // For some reason the solution from https://www.eclipse.org/lists/jgit-dev/msg01892.html does not work
        // This solution is quite simple but might not work in special cases, for us it should suffice.
<span class="fc" id="L78">        return Files.exists(Path.of(repositoryPath.toString(), &quot;.git&quot;));</span>
    }

    /**
     * Checkout the branch with the specified name, if it does not exist create it
     *
     * @param branchToCheckout Name of the branch to checkout
     */
    public void checkoutBranch(String branchToCheckout) throws IOException, GitAPIException {
<span class="fc" id="L87">        try (Git git = Git.open(this.repositoryPathAsFile)) {</span>
<span class="fc" id="L88">            Optional&lt;Ref&gt; branch = getRefForBranch(branchToCheckout);</span>
<span class="fc" id="L89">            git.checkout()</span>
               // If the branch does not exist, create it
<span class="fc" id="L91">               .setCreateBranch(branch.isEmpty())</span>
<span class="fc" id="L92">               .setName(branchToCheckout)</span>
<span class="fc" id="L93">               .call();</span>
        }
<span class="fc" id="L95">    }</span>

    /**
     * Returns the reference of the specified branch
     * If it does not exist returns an empty optional
     */
    Optional&lt;Ref&gt; getRefForBranch(String branchName) throws GitAPIException, IOException {
<span class="fc" id="L102">        try (Git git = Git.open(this.repositoryPathAsFile)) {</span>
<span class="fc" id="L103">            return git.branchList()</span>
<span class="fc" id="L104">                      .call()</span>
<span class="fc" id="L105">                      .stream()</span>
<span class="fc" id="L106">                      .filter(ref -&gt; ref.getName().equals(&quot;refs/heads/&quot; + branchName))</span>
<span class="fc" id="L107">                      .findAny();</span>
        }
    }

    /**
     * Creates a commit on the currently checked out branch
     * @param amend Whether to amend to the last commit (true), or not (false)
     * @return Returns true if a new commit was created. This is the case if the repository was not clean on method invocation
     */
    public boolean createCommitOnCurrentBranch(String commitMessage, boolean amend) throws IOException, GitAPIException {
<span class="fc" id="L117">        boolean commitCreated = false;</span>
<span class="fc" id="L118">        try (Git git = Git.open(this.repositoryPathAsFile)) {</span>
<span class="fc" id="L119">            Status status = git.status().call();</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">            if (!status.isClean()) {</span>
<span class="fc" id="L121">                commitCreated = true;</span>
                // Add new and changed files to index
<span class="fc" id="L123">                git.add()</span>
<span class="fc" id="L124">                   .addFilepattern(&quot;.&quot;)</span>
<span class="fc" id="L125">                   .call();</span>
                // Add all removed files to index
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">                if (!status.getMissing().isEmpty()) {</span>
<span class="nc" id="L128">                    RmCommand removeCommand = git.rm()</span>
<span class="nc" id="L129">                                                 .setCached(true);</span>
<span class="nc" id="L130">                    status.getMissing().forEach(removeCommand::addFilepattern);</span>
<span class="nc" id="L131">                    removeCommand.call();</span>
                }
<span class="fc" id="L133">                git.commit()</span>
<span class="fc" id="L134">                   .setAmend(amend)</span>
<span class="fc" id="L135">                   .setAllowEmpty(false)</span>
<span class="fc" id="L136">                   .setMessage(commitMessage)</span>
<span class="fc" id="L137">                   .call();</span>
            }
        }
<span class="fc" id="L140">        return commitCreated;</span>
    }

    /**
     * Merges the source branch into the target branch
     *
     * @param targetBranch the name of the branch that is merged into
     * @param sourceBranch the name of the branch that gets merged
     */
    public void mergeBranches(String targetBranch, String sourceBranch, MergeStrategy mergeStrategy) throws IOException, GitAPIException {
<span class="nc" id="L150">        String currentBranch = this.getCurrentlyCheckedOutBranch();</span>
<span class="nc" id="L151">        try (Git git = Git.open(this.repositoryPathAsFile)) {</span>
<span class="nc" id="L152">            Optional&lt;Ref&gt; sourceBranchRef = getRefForBranch(sourceBranch);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">            if (sourceBranchRef.isEmpty()) {</span>
                // Do nothing
<span class="nc" id="L155">                return;</span>
            }
<span class="nc" id="L157">            this.checkoutBranch(targetBranch);</span>
<span class="nc" id="L158">            git.merge()</span>
<span class="nc" id="L159">               .include(sourceBranchRef.get())</span>
<span class="nc" id="L160">               .setStrategy(mergeStrategy)</span>
<span class="nc" id="L161">               .setMessage(&quot;Merge search branch into working branch.&quot;)</span>
<span class="nc" id="L162">               .call();</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        }</span>
<span class="nc" id="L164">        this.checkoutBranch(currentBranch);</span>
<span class="nc" id="L165">    }</span>

    /**
     * Pushes all commits made to the branch that is tracked by the currently checked out branch.
     * If pushing to remote fails, it fails silently.
     */
    public void pushCommitsToRemoteRepository() throws IOException {
<span class="nc" id="L172">        try (Git git = Git.open(this.repositoryPathAsFile)) {</span>
            try {
<span class="nc" id="L174">                git.push()</span>
<span class="nc" id="L175">                   .setCredentialsProvider(credentialsProvider)</span>
<span class="nc" id="L176">                   .call();</span>
<span class="nc" id="L177">            } catch (GitAPIException e) {</span>
<span class="nc" id="L178">                LOGGER.info(&quot;Failed to push&quot;);</span>
<span class="nc" id="L179">            }</span>
        }
<span class="nc" id="L181">    }</span>

    public void pullOnCurrentBranch() throws IOException {
<span class="nc" id="L184">        try (Git git = Git.open(this.repositoryPathAsFile)) {</span>
            try {
<span class="nc" id="L186">                git.pull()</span>
<span class="nc" id="L187">                   .setCredentialsProvider(credentialsProvider)</span>
<span class="nc" id="L188">                   .call();</span>
<span class="nc" id="L189">            } catch (GitAPIException e) {</span>
<span class="nc" id="L190">                LOGGER.info(&quot;Failed to push&quot;);</span>
<span class="nc" id="L191">            }</span>
        }
<span class="nc" id="L193">    }</span>

    public String getCurrentlyCheckedOutBranch() throws IOException {
<span class="fc" id="L196">        try (Git git = Git.open(this.repositoryPathAsFile)) {</span>
<span class="fc" id="L197">            return git.getRepository().getBranch();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>