<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="sv"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JabRefGUI.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JabRef</a> &gt; <a href="index.source.html" class="el_package">org.jabref.gui</a> &gt; <span class="el_source">JabRefGUI.java</span></div><h1>JabRefGUI.java</h1><pre class="source lang-java linenums">package org.jabref.gui;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

import javafx.application.Platform;
import javafx.scene.Scene;
import javafx.scene.input.KeyEvent;
import javafx.stage.Screen;
import javafx.stage.Stage;

import org.jabref.gui.dialogs.BackupUIManager;
import org.jabref.gui.help.VersionWorker;
import org.jabref.gui.icon.IconTheme;
import org.jabref.gui.importer.ParserResultWarningDialog;
import org.jabref.gui.importer.actions.OpenDatabaseAction;
import org.jabref.gui.keyboard.TextInputKeyBindings;
import org.jabref.gui.shared.SharedDatabaseUIManager;
import org.jabref.logic.autosaveandbackup.BackupManager;
import org.jabref.logic.importer.OpenDatabase;
import org.jabref.logic.importer.ParserResult;
import org.jabref.logic.l10n.Localization;
import org.jabref.logic.shared.DatabaseNotSupportedException;
import org.jabref.logic.shared.exception.InvalidDBMSConnectionPropertiesException;
import org.jabref.logic.shared.exception.NotASharedDatabaseException;
import org.jabref.preferences.GuiPreferences;
import org.jabref.preferences.PreferencesService;

import impl.org.controlsfx.skin.DecorationPane;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class JabRefGUI {

<span class="nc" id="L40">    private static final Logger LOGGER = LoggerFactory.getLogger(JabRefGUI.class);</span>

    private static JabRefFrame mainFrame;
    private final PreferencesService preferencesService;

    private final List&lt;ParserResult&gt; bibDatabases;
    private final boolean isBlank;
    private boolean correctedWindowPos;
<span class="nc" id="L48">    private final List&lt;ParserResult&gt; failed = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L49">    private final List&lt;ParserResult&gt; toOpenTab = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L51">    public JabRefGUI(Stage mainStage, List&lt;ParserResult&gt; databases, boolean isBlank, PreferencesService preferencesService) {</span>
<span class="nc" id="L52">        this.bibDatabases = databases;</span>
<span class="nc" id="L53">        this.isBlank = isBlank;</span>
<span class="nc" id="L54">        this.preferencesService = preferencesService;</span>
<span class="nc" id="L55">        this.correctedWindowPos = false;</span>

<span class="nc" id="L57">        mainFrame = new JabRefFrame(mainStage);</span>

<span class="nc" id="L59">        openWindow(mainStage);</span>

<span class="nc" id="L61">        new VersionWorker(Globals.BUILD_INFO.version,</span>
<span class="nc" id="L62">                mainFrame.getDialogService(),</span>
                Globals.TASK_EXECUTOR,
<span class="nc" id="L64">                preferencesService.getInternalPreferences())</span>
<span class="nc" id="L65">                .checkForNewVersionDelayed();</span>
<span class="nc" id="L66">    }</span>

    private void openWindow(Stage mainStage) {
<span class="nc" id="L69">        LOGGER.debug(&quot;Initializing frame&quot;);</span>
<span class="nc" id="L70">        mainFrame.init();</span>

<span class="nc" id="L72">        GuiPreferences guiPreferences = preferencesService.getGuiPreferences();</span>
        // Restore window location and/or maximised state
<span class="nc bnc" id="L74" title="All 2 branches missed.">        if (guiPreferences.isWindowMaximised()) {</span>
<span class="nc" id="L75">            mainStage.setMaximized(true);</span>
<span class="nc bnc" id="L76" title="All 4 branches missed.">        } else if ((Screen.getScreens().size() == 1) &amp;&amp; isWindowPositionOutOfBounds()) {</span>
            // corrects the Window, if its outside of the mainscreen
<span class="nc" id="L78">            LOGGER.debug(&quot;The Jabref Window is outside the Main Monitor\n&quot;);</span>
<span class="nc" id="L79">            mainStage.setX(0);</span>
<span class="nc" id="L80">            mainStage.setY(0);</span>
<span class="nc" id="L81">            mainStage.setWidth(1024);</span>
<span class="nc" id="L82">            mainStage.setHeight(768);</span>
<span class="nc" id="L83">            correctedWindowPos = true;</span>
        } else {
<span class="nc" id="L85">            mainStage.setX(guiPreferences.getPositionX());</span>
<span class="nc" id="L86">            mainStage.setY(guiPreferences.getPositionY());</span>
<span class="nc" id="L87">            mainStage.setWidth(guiPreferences.getSizeX());</span>
<span class="nc" id="L88">            mainStage.setHeight(guiPreferences.getSizeY());</span>
        }
<span class="nc" id="L90">        debugLogWindowState(mainStage);</span>

        // We create a decoration pane ourselves for performance reasons
        // (otherwise it has to be injected later, leading to a complete redraw/relayout of the complete scene)
<span class="nc" id="L94">        DecorationPane root = new DecorationPane();</span>
<span class="nc" id="L95">        root.getChildren().add(JabRefGUI.mainFrame);</span>

<span class="nc" id="L97">        Scene scene = new Scene(root, 800, 800);</span>
<span class="nc" id="L98">        Globals.getThemeManager().installCss(scene);</span>

        // Handle TextEditor key bindings
<span class="nc" id="L101">        scene.addEventFilter(KeyEvent.KEY_PRESSED, event -&gt; TextInputKeyBindings.call(scene, event));</span>

<span class="nc" id="L103">        mainStage.setTitle(JabRefFrame.FRAME_TITLE);</span>
<span class="nc" id="L104">        mainStage.getIcons().addAll(IconTheme.getLogoSetFX());</span>
<span class="nc" id="L105">        mainStage.setScene(scene);</span>
<span class="nc" id="L106">        mainStage.show();</span>

<span class="nc" id="L108">        mainStage.setOnCloseRequest(event -&gt; {</span>
<span class="nc bnc" id="L109" title="All 2 branches missed.">            if (!correctedWindowPos) {</span>
                // saves the window position only if its not  corrected -&gt; the window will rest at the old Position,
                // if the external Screen is connected again.
<span class="nc" id="L112">                saveWindowState(mainStage);</span>
            }
<span class="nc" id="L114">            boolean reallyQuit = mainFrame.quit();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            if (!reallyQuit) {</span>
<span class="nc" id="L116">                event.consume();</span>
            }
<span class="nc" id="L118">        });</span>
<span class="nc" id="L119">        Platform.runLater(this::openDatabases);</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (!(Globals.getFileUpdateMonitor().isActive())) {</span>
<span class="nc" id="L122">            getMainFrame().getDialogService()</span>
<span class="nc" id="L123">                          .showErrorDialogAndWait(Localization.lang(&quot;Unable to monitor file changes. Please close files &quot; +</span>
                                  &quot;and processes and restart. You may encounter errors if you continue &quot; +
                                  &quot;with this session.&quot;));
        }
<span class="nc" id="L127">    }</span>

    private void openDatabases() {
        // If the option is enabled, open the last edited libraries, if any.
<span class="nc bnc" id="L131" title="All 4 branches missed.">        if (!isBlank &amp;&amp; preferencesService.getImportExportPreferences().shouldOpenLastEdited()) {</span>
<span class="nc" id="L132">            openLastEditedDatabases();</span>
        }

        // Remove invalid databases
<span class="nc" id="L136">        List&lt;ParserResult&gt; invalidDatabases = bibDatabases.stream()</span>
<span class="nc" id="L137">                                                          .filter(ParserResult::isInvalid)</span>
<span class="nc" id="L138">                                                          .collect(Collectors.toList());</span>
<span class="nc" id="L139">        failed.addAll(invalidDatabases);</span>
<span class="nc" id="L140">        bibDatabases.removeAll(invalidDatabases);</span>

        // passed file (we take the first one) should be focused
<span class="nc" id="L143">        Path focusedFile = bibDatabases.stream()</span>
<span class="nc" id="L144">                                       .findFirst()</span>
<span class="nc" id="L145">                                       .flatMap(ParserResult::getPath)</span>
<span class="nc" id="L146">                                       .orElse(preferencesService.getGuiPreferences()</span>
<span class="nc" id="L147">                                                                 .getLastFocusedFile())</span>
<span class="nc" id="L148">                                       .toAbsolutePath();</span>

        // Add all bibDatabases databases to the frame:
<span class="nc" id="L151">        boolean first = false;</span>
<span class="nc bnc" id="L152" title="All 2 branches missed.">        for (ParserResult pr : bibDatabases) {</span>
            // Define focused tab
<span class="nc bnc" id="L154" title="All 2 branches missed.">            if (pr.getPath().filter(path -&gt; path.toAbsolutePath().equals(focusedFile)).isPresent()) {</span>
<span class="nc" id="L155">                first = true;</span>
            }

<span class="nc bnc" id="L158" title="All 2 branches missed.">            if (pr.getDatabase().isShared()) {</span>
                try {
<span class="nc" id="L160">                    new SharedDatabaseUIManager(mainFrame).openSharedDatabaseFromParserResult(pr);</span>
<span class="nc" id="L161">                } catch (SQLException | DatabaseNotSupportedException | InvalidDBMSConnectionPropertiesException |</span>
                        NotASharedDatabaseException e) {
<span class="nc" id="L163">                    pr.getDatabaseContext().clearDatabasePath(); // do not open the original file</span>
<span class="nc" id="L164">                    pr.getDatabase().clearSharedDatabaseID();</span>

<span class="nc" id="L166">                    LOGGER.error(&quot;Connection error&quot;, e);</span>
<span class="nc" id="L167">                    mainFrame.getDialogService().showErrorDialogAndWait(</span>
<span class="nc" id="L168">                            Localization.lang(&quot;Connection error&quot;),</span>
<span class="nc" id="L169">                            Localization.lang(&quot;A local copy will be opened.&quot;),</span>
                            e);
<span class="nc" id="L171">                }</span>
<span class="nc" id="L172">                toOpenTab.add(pr);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">            } else if (pr.toOpenTab()) {</span>
                // things to be appended to an opened tab should be done after opening all tabs
                // add them to the list
<span class="nc" id="L176">                toOpenTab.add(pr);</span>
            } else {
<span class="nc" id="L178">                mainFrame.addParserResult(pr, first);</span>
<span class="nc" id="L179">                first = false;</span>
            }
<span class="nc" id="L181">        }</span>

        // finally add things to the currently opened tab
<span class="nc bnc" id="L184" title="All 2 branches missed.">        for (ParserResult pr : toOpenTab) {</span>
<span class="nc" id="L185">            mainFrame.addParserResult(pr, first);</span>
<span class="nc" id="L186">            first = false;</span>
<span class="nc" id="L187">        }</span>

<span class="nc bnc" id="L189" title="All 2 branches missed.">        for (ParserResult pr : failed) {</span>
<span class="nc" id="L190">            String message = Localization.lang(&quot;Error opening file '%0'.&quot;,</span>
<span class="nc" id="L191">                    pr.getPath().map(Path::toString).orElse(&quot;(File name unknown)&quot;)) + &quot;\n&quot; +</span>
<span class="nc" id="L192">                    pr.getErrorMessage();</span>

<span class="nc" id="L194">            mainFrame.getDialogService().showErrorDialogAndWait(Localization.lang(&quot;Error opening file&quot;), message);</span>
<span class="nc" id="L195">        }</span>

        // Display warnings, if any
<span class="nc" id="L198">        int tabNumber = 0;</span>
<span class="nc bnc" id="L199" title="All 2 branches missed.">        for (ParserResult pr : bibDatabases) {</span>
<span class="nc" id="L200">            ParserResultWarningDialog.showParserResultWarningDialog(pr, mainFrame, tabNumber++);</span>
<span class="nc" id="L201">        }</span>

        // After adding the databases, go through each and see if
        // any post open actions need to be done. For instance, checking
        // if we found new entry types that can be imported, or checking
        // if the database contents should be modified due to new features
        // in this version of JabRef.
        // Note that we have to check whether i does not go over getBasePanelCount().
        // This is because importToOpen might have been used, which adds to
        // loadedDatabases, but not to getBasePanelCount()

<span class="nc bnc" id="L212" title="All 4 branches missed.">        for (int i = 0; (i &lt; bibDatabases.size()) &amp;&amp; (i &lt; mainFrame.getBasePanelCount()); i++) {</span>
<span class="nc" id="L213">            ParserResult pr = bibDatabases.get(i);</span>
<span class="nc" id="L214">            LibraryTab libraryTab = mainFrame.getLibraryTabAt(i);</span>

<span class="nc" id="L216">            OpenDatabaseAction.performPostOpenActions(libraryTab, pr);</span>
        }

<span class="nc" id="L219">        LOGGER.debug(&quot;Finished adding panels&quot;);</span>
<span class="nc" id="L220">    }</span>

    private void saveWindowState(Stage mainStage) {
<span class="nc" id="L223">        GuiPreferences preferences = preferencesService.getGuiPreferences();</span>
<span class="nc" id="L224">        preferences.setPositionX(mainStage.getX());</span>
<span class="nc" id="L225">        preferences.setPositionY(mainStage.getY());</span>
<span class="nc" id="L226">        preferences.setSizeX(mainStage.getWidth());</span>
<span class="nc" id="L227">        preferences.setSizeY(mainStage.getHeight());</span>
<span class="nc" id="L228">        preferences.setWindowMaximised(mainStage.isMaximized());</span>
<span class="nc" id="L229">        debugLogWindowState(mainStage);</span>
<span class="nc" id="L230">    }</span>

    /**
     * outprints the Data from the Screen (only in debug mode)
     *
     * @param mainStage JabRefs stage
     */
    private void debugLogWindowState(Stage mainStage) {
<span class="nc bnc" id="L238" title="All 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L239">            String debugLogString = &quot;SCREEN DATA:&quot; +</span>
<span class="nc" id="L240">                    &quot;mainStage.WINDOW_MAXIMISED: &quot; + mainStage.isMaximized() + &quot;\n&quot; +</span>
<span class="nc" id="L241">                    &quot;mainStage.POS_X: &quot; + mainStage.getX() + &quot;\n&quot; +</span>
<span class="nc" id="L242">                    &quot;mainStage.POS_Y: &quot; + mainStage.getY() + &quot;\n&quot; +</span>
<span class="nc" id="L243">                    &quot;mainStage.SIZE_X: &quot; + mainStage.getWidth() + &quot;\n&quot; +</span>
<span class="nc" id="L244">                    &quot;mainStages.SIZE_Y: &quot; + mainStage.getHeight() + &quot;\n&quot;;</span>
<span class="nc" id="L245">            LOGGER.debug(debugLogString);</span>
        }
<span class="nc" id="L247">    }</span>

    /**
     * Tests if the window coordinates are out of the mainscreen
     *
     * @return outbounds
     */
    private boolean isWindowPositionOutOfBounds() {
<span class="nc bnc" id="L255" title="All 2 branches missed.">        return !Screen.getPrimary().getBounds().contains(</span>
<span class="nc" id="L256">                preferencesService.getGuiPreferences().getPositionX(),</span>
<span class="nc" id="L257">                preferencesService.getGuiPreferences().getPositionY());</span>
    }

    private void openLastEditedDatabases() {
<span class="nc" id="L261">        List&lt;String&gt; lastFiles = preferencesService.getGuiPreferences().getLastFilesOpened();</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (lastFiles.isEmpty()) {</span>
<span class="nc" id="L263">            return;</span>
        }

<span class="nc bnc" id="L266" title="All 2 branches missed.">        for (String fileName : lastFiles) {</span>
<span class="nc" id="L267">            Path dbFile = Path.of(fileName);</span>

            // Already parsed via command line parameter, e.g., &quot;jabref.jar somefile.bib&quot;
<span class="nc bnc" id="L270" title="All 4 branches missed.">            if (isLoaded(dbFile) || !Files.exists(dbFile)) {</span>
<span class="nc" id="L271">                continue;</span>
            }

<span class="nc bnc" id="L274" title="All 2 branches missed.">            if (BackupManager.backupFileDiffers(dbFile)) {</span>
<span class="nc" id="L275">                BackupUIManager.showRestoreBackupDialog(mainFrame.getDialogService(), dbFile);</span>
            }

            ParserResult parsedDatabase;
            try {
<span class="nc" id="L280">                parsedDatabase = OpenDatabase.loadDatabase(</span>
                        dbFile,
<span class="nc" id="L282">                        preferencesService.getGeneralPreferences(),</span>
<span class="nc" id="L283">                        preferencesService.getImportFormatPreferences(),</span>
<span class="nc" id="L284">                        Globals.getFileUpdateMonitor());</span>
<span class="nc" id="L285">            } catch (IOException ex) {</span>
<span class="nc" id="L286">                LOGGER.error(&quot;Error opening file '{}'&quot;, dbFile, ex);</span>
<span class="nc" id="L287">                parsedDatabase = ParserResult.fromError(ex);</span>
<span class="nc" id="L288">            }</span>
<span class="nc" id="L289">            bibDatabases.add(parsedDatabase);</span>
<span class="nc" id="L290">        }</span>
<span class="nc" id="L291">    }</span>

    private boolean isLoaded(Path fileToOpen) {
<span class="nc bnc" id="L294" title="All 4 branches missed.">        return bibDatabases.stream().anyMatch(pr -&gt; pr.getPath().isPresent() &amp;&amp; pr.getPath().get().equals(fileToOpen));</span>
    }

    public static JabRefFrame getMainFrame() {
<span class="nc" id="L298">        return mainFrame;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>