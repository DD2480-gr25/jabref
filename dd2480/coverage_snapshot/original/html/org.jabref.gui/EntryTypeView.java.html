<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EntryTypeView.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JabRef</a> &gt; <a href="index.source.html" class="el_package">org.jabref.gui</a> &gt; <span class="el_source">EntryTypeView.java</span></div><h1>EntryTypeView.java</h1><pre class="source lang-java linenums">package org.jabref.gui;

import java.util.Collection;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import javax.inject.Inject;

import javafx.application.Platform;
import javafx.event.Event;
import javafx.fxml.FXML;
import javafx.scene.control.Button;
import javafx.scene.control.ButtonType;
import javafx.scene.control.ComboBox;
import javafx.scene.control.TextField;
import javafx.scene.control.TitledPane;
import javafx.scene.control.Tooltip;
import javafx.scene.layout.FlowPane;
import javafx.stage.Screen;

import org.jabref.gui.util.BaseDialog;
import org.jabref.gui.util.ControlHelper;
import org.jabref.gui.util.IconValidationDecorator;
import org.jabref.gui.util.ViewModelListCellFactory;
import org.jabref.logic.importer.IdBasedFetcher;
import org.jabref.logic.importer.WebFetcher;
import org.jabref.logic.l10n.Localization;
import org.jabref.model.database.BibDatabaseMode;
import org.jabref.model.entry.BibEntryType;
import org.jabref.model.entry.types.BiblatexEntryTypeDefinitions;
import org.jabref.model.entry.types.BiblatexSoftwareEntryTypeDefinitions;
import org.jabref.model.entry.types.BibtexEntryTypeDefinitions;
import org.jabref.model.entry.types.EntryType;
import org.jabref.model.entry.types.IEEETranEntryTypeDefinitions;
import org.jabref.model.entry.types.StandardEntryType;
import org.jabref.model.strings.StringUtil;
import org.jabref.preferences.PreferencesService;

import com.airhacks.afterburner.views.ViewLoader;
import com.tobiasdiez.easybind.EasyBind;
import de.saxsys.mvvmfx.utils.validation.visualization.ControlsFxVisualizer;

/**
 * Dialog that prompts the user to choose a type for an entry.
 */
public class EntryTypeView extends BaseDialog&lt;EntryType&gt; {

    @Inject StateManager stateManager;

    @FXML private ButtonType generateButton;
    @FXML private TextField idTextField;
    @FXML private ComboBox&lt;IdBasedFetcher&gt; idBasedFetchers;
    @FXML private FlowPane recommendedEntriesPane;
    @FXML private FlowPane otherEntriesPane;
    @FXML private FlowPane customPane;
    @FXML private TitledPane recommendedEntriesTitlePane;
    @FXML private TitledPane otherEntriesTitlePane;
    @FXML private TitledPane customTitlePane;

    private final LibraryTab libraryTab;
    private final DialogService dialogService;
    private final PreferencesService preferencesService;

    private EntryType type;
    private EntryTypeViewModel viewModel;
<span class="nc" id="L67">    private final ControlsFxVisualizer visualizer = new ControlsFxVisualizer();</span>

<span class="nc" id="L69">    public EntryTypeView(LibraryTab libraryTab, DialogService dialogService, PreferencesService preferences) {</span>
<span class="nc" id="L70">        this.libraryTab = libraryTab;</span>
<span class="nc" id="L71">        this.dialogService = dialogService;</span>
<span class="nc" id="L72">        this.preferencesService = preferences;</span>

<span class="nc" id="L74">        this.setTitle(Localization.lang(&quot;Select entry type&quot;));</span>
<span class="nc" id="L75">        ViewLoader.view(this)</span>
<span class="nc" id="L76">                  .load()</span>
<span class="nc" id="L77">                  .setAsDialogPane(this);</span>

<span class="nc" id="L79">        ControlHelper.setAction(generateButton, this.getDialogPane(), event -&gt; viewModel.runFetcherWorker());</span>

<span class="nc" id="L81">        setResultConverter(button -&gt; {</span>
            // The buttonType will always be &quot;cancel&quot;, even if we pressed one of the entry type buttons
<span class="nc" id="L83">            return type;</span>
        });

<span class="nc" id="L86">        Button btnGenerate = (Button) this.getDialogPane().lookupButton(generateButton);</span>

<span class="nc bnc" id="L88" title="All 2 branches missed.">        btnGenerate.textProperty().bind(EasyBind.map(viewModel.searchingProperty(), searching -&gt; (searching) ? Localization.lang(&quot;Searching...&quot;) : Localization.lang(&quot;Generate&quot;)));</span>
<span class="nc" id="L89">        btnGenerate.disableProperty().bind(viewModel.idFieldValidationStatus().validProperty().not().or(viewModel.searchingProperty()));</span>

<span class="nc" id="L91">        EasyBind.subscribe(viewModel.searchSuccesfulProperty(), value -&gt; {</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            if (value) {</span>
<span class="nc" id="L93">                setEntryTypeForReturnAndClose(Optional.empty());</span>
            }
<span class="nc" id="L95">        });</span>
<span class="nc" id="L96">    }</span>

    private void addEntriesToPane(FlowPane pane, Collection&lt;? extends BibEntryType&gt; entries) {
<span class="nc bnc" id="L99" title="All 2 branches missed.">        for (BibEntryType entryType : entries) {</span>
<span class="nc" id="L100">            Button entryButton = new Button(entryType.getType().getDisplayName());</span>
<span class="nc" id="L101">            entryButton.setUserData(entryType);</span>
<span class="nc" id="L102">            entryButton.setOnAction(event -&gt; setEntryTypeForReturnAndClose(Optional.of(entryType)));</span>
<span class="nc" id="L103">            pane.getChildren().add(entryButton);</span>

<span class="nc" id="L105">            EntryType selectedType = entryType.getType();</span>
<span class="nc" id="L106">            String description = getDescription(selectedType);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">            if (StringUtil.isNotBlank(description)) {</span>
<span class="nc" id="L108">                Screen currentScreen = Screen.getPrimary();</span>
<span class="nc" id="L109">                double maxWidth = currentScreen.getBounds().getWidth();</span>
<span class="nc" id="L110">                Tooltip tooltip = new Tooltip(description);</span>
<span class="nc" id="L111">                tooltip.setMaxWidth((maxWidth * 2) / 3);</span>
<span class="nc" id="L112">                tooltip.setWrapText(true);</span>
<span class="nc" id="L113">                entryButton.setTooltip(tooltip);</span>
            }
<span class="nc" id="L115">        }</span>
<span class="nc" id="L116">    }</span>

    @FXML
    public void initialize() {
<span class="nc" id="L120">        visualizer.setDecoration(new IconValidationDecorator());</span>
<span class="nc" id="L121">        viewModel = new EntryTypeViewModel(preferencesService, libraryTab, dialogService, stateManager);</span>

<span class="nc" id="L123">        idBasedFetchers.itemsProperty().bind(viewModel.fetcherItemsProperty());</span>
<span class="nc" id="L124">        idTextField.textProperty().bindBidirectional(viewModel.idTextProperty());</span>
<span class="nc" id="L125">        idBasedFetchers.valueProperty().bindBidirectional(viewModel.selectedItemProperty());</span>

<span class="nc" id="L127">        EasyBind.subscribe(viewModel.getFocusAndSelectAllProperty(), evt -&gt; {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            if (evt) {</span>
<span class="nc" id="L129">                idTextField.requestFocus();</span>
<span class="nc" id="L130">                idTextField.selectAll();</span>
            }
<span class="nc" id="L132">        });</span>

<span class="nc" id="L134">        new ViewModelListCellFactory&lt;IdBasedFetcher&gt;().withText(WebFetcher::getName).install(idBasedFetchers);</span>

        // we set the managed property so that they will only be rendered when they are visble so that the Nodes only take the space when visible
        // avoids removing and adding from the scence graph
<span class="nc" id="L138">        recommendedEntriesTitlePane.managedProperty().bind(recommendedEntriesTitlePane.visibleProperty());</span>
<span class="nc" id="L139">        otherEntriesTitlePane.managedProperty().bind(otherEntriesTitlePane.visibleProperty());</span>
<span class="nc" id="L140">        customTitlePane.managedProperty().bind(customTitlePane.visibleProperty());</span>

<span class="nc" id="L142">        otherEntriesTitlePane.expandedProperty().addListener((obs, wasExpanded, isNowExpanded) -&gt; {</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (isNowExpanded) {</span>
<span class="nc" id="L144">                this.setHeight(this.getHeight() + otherEntriesPane.getHeight());</span>
            } else {
<span class="nc" id="L146">                this.setHeight(this.getHeight() - otherEntriesPane.getHeight());</span>
            }
<span class="nc" id="L148">        });</span>

<span class="nc" id="L150">        boolean isBiblatexMode = libraryTab.getBibDatabaseContext().isBiblatexMode();</span>
        List&lt;BibEntryType&gt; recommendedEntries;
        List&lt;BibEntryType&gt; otherEntries;
<span class="nc bnc" id="L153" title="All 2 branches missed.">        if (isBiblatexMode) {</span>
<span class="nc" id="L154">            recommendedEntries = BiblatexEntryTypeDefinitions.RECOMMENDED;</span>
<span class="nc" id="L155">            otherEntries = BiblatexEntryTypeDefinitions.ALL</span>
<span class="nc" id="L156">                .stream()</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">                .filter(e -&gt; !recommendedEntries.contains(e))</span>
<span class="nc" id="L158">                .collect(Collectors.toList());</span>
<span class="nc" id="L159">            otherEntries.addAll(BiblatexSoftwareEntryTypeDefinitions.ALL);</span>
        } else {
<span class="nc" id="L161">            recommendedEntries = BibtexEntryTypeDefinitions.RECOMMENDED;</span>
<span class="nc" id="L162">            otherEntries = BibtexEntryTypeDefinitions.ALL</span>
<span class="nc" id="L163">                .stream()</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">                .filter(e -&gt; !recommendedEntries.contains(e))</span>
<span class="nc" id="L165">                .collect(Collectors.toList());</span>
<span class="nc" id="L166">            otherEntries.addAll(IEEETranEntryTypeDefinitions.ALL);</span>
        }
<span class="nc" id="L168">        addEntriesToPane(recommendedEntriesPane, recommendedEntries);</span>
<span class="nc" id="L169">        addEntriesToPane(otherEntriesPane, otherEntries);</span>

<span class="nc bnc" id="L171" title="All 2 branches missed.">        BibDatabaseMode customTypeDatabaseMode = isBiblatexMode ? BibDatabaseMode.BIBLATEX : BibDatabaseMode.BIBTEX;</span>
<span class="nc" id="L172">        List&lt;BibEntryType&gt; customTypes = Globals.entryTypesManager.getAllCustomTypes(customTypeDatabaseMode);</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">        if (customTypes.isEmpty()) {</span>
<span class="nc" id="L174">            customTitlePane.setVisible(false);</span>
        } else {
<span class="nc" id="L176">            addEntriesToPane(customPane, customTypes);</span>
        }

<span class="nc" id="L179">        viewModel.idTextProperty().addListener((obs, oldValue, newValue) -&gt;</span>
<span class="nc" id="L180">                visualizer.initVisualization(viewModel.idFieldValidationStatus(), idTextField, true));</span>

<span class="nc" id="L182">        Platform.runLater(() -&gt; idTextField.requestFocus());</span>
<span class="nc" id="L183">    }</span>

    public EntryType getChoice() {
<span class="nc" id="L186">        return type;</span>
    }

    @FXML
    private void runFetcherWorker(Event event) {
<span class="nc" id="L191">        viewModel.runFetcherWorker();</span>
<span class="nc" id="L192">    }</span>

    @FXML
    private void focusTextField(Event event) {
<span class="nc" id="L196">        idTextField.requestFocus();</span>
<span class="nc" id="L197">        idTextField.selectAll();</span>
<span class="nc" id="L198">    }</span>

    private void setEntryTypeForReturnAndClose(Optional&lt;BibEntryType&gt; entryType) {
<span class="nc" id="L201">        type = entryType.map(BibEntryType::getType).orElse(null);</span>
<span class="nc" id="L202">        viewModel.stopFetching();</span>
<span class="nc" id="L203">        this.stateManager.clearSearchQuery();</span>
<span class="nc" id="L204">        this.close();</span>
<span class="nc" id="L205">    }</span>

    /**
     * The description is originating from biblatex manual chapter 2 Biblatex documentation is favored over the bibtex, since bibtex is a subset of biblatex and biblatex is better documented.
     */
    public static String getDescription(EntryType selectedType) {
<span class="nc bnc" id="L211" title="All 2 branches missed.">        if (selectedType instanceof StandardEntryType) {</span>
<span class="nc bnc" id="L212" title="All 33 branches missed.">            switch ((StandardEntryType) selectedType) {</span>
                case Article -&gt; {
<span class="nc" id="L214">                    return Localization.lang(&quot;An article in a journal, magazine, newspaper, or other periodical which forms a self-contained unit with its own title.&quot;);</span>
                }
                case Book -&gt; {
<span class="nc" id="L217">                    return Localization.lang(&quot;A single-volume book with one or more authors where the authors share credit for the work as a whole.&quot;);</span>
                }
                case Booklet -&gt; {
<span class="nc" id="L220">                    return Localization.lang(&quot;A book-like work without a formal publisher or sponsoring institution.&quot;);</span>
                }
                case Collection -&gt; {
<span class="nc" id="L223">                    return Localization.lang(&quot;A single-volume collection with multiple, self-contained contributions by distinct authors which have their own title. The work as a whole has no overall author but it will usually have an editor.&quot;);</span>
                }
                case Conference -&gt; {
<span class="nc" id="L226">                    return Localization.lang(&quot;A legacy alias for \&quot;InProceedings\&quot;.&quot;);</span>
                }
                case InBook -&gt; {
<span class="nc" id="L229">                    return Localization.lang(&quot;A part of a book which forms a self-contained unit with its own title.&quot;);</span>
                }
                case InCollection -&gt; {
<span class="nc" id="L232">                    return Localization.lang(&quot;A contribution to a collection which forms a self-contained unit with a distinct author and title.&quot;);</span>
                }
                case InProceedings -&gt; {
<span class="nc" id="L235">                    return Localization.lang(&quot;An article in a conference proceedings.&quot;);</span>
                }
                case Manual -&gt; {
<span class="nc" id="L238">                    return Localization.lang(&quot;Technical or other documentation, not necessarily in printed form.&quot;);</span>
                }
                case MastersThesis -&gt; {
<span class="nc" id="L241">                    return Localization.lang(&quot;Similar to \&quot;Thesis\&quot; except that the type field is optional and defaults to the localised term  Master's thesis.&quot;);</span>
                }
                case Misc -&gt; {
<span class="nc" id="L244">                    return Localization.lang(&quot;A fallback type for entries which do not fit into any other category.&quot;);</span>
                }
                case PhdThesis -&gt; {
<span class="nc" id="L247">                    return Localization.lang(&quot;Similar to \&quot;Thesis\&quot; except that the type field is optional and defaults to the localised term PhD thesis.&quot;);</span>
                }
                case Proceedings -&gt; {
<span class="nc" id="L250">                    return Localization.lang(&quot;A single-volume conference proceedings. This type is very similar to \&quot;Collection\&quot;.&quot;);</span>
                }
                case TechReport -&gt; {
<span class="nc" id="L253">                    return Localization.lang(&quot;Similar to \&quot;Report\&quot; except that the type field is optional and defaults to the localised term technical report.&quot;);</span>
                }
                case Unpublished -&gt; {
<span class="nc" id="L256">                    return Localization.lang(&quot;A work with an author and a title which has not been formally published, such as a manuscript or the script of a talk.&quot;);</span>
                }
                case BookInBook -&gt; {
<span class="nc" id="L259">                    return Localization.lang(&quot;This type is similar to \&quot;InBook\&quot; but intended for works originally published as a stand-alone book.&quot;);</span>
                }
                case InReference -&gt; {
<span class="nc" id="L262">                    return Localization.lang(&quot;An article in a work of reference. This is a more specific variant of the generic \&quot;InCollection\&quot; entry type.&quot;);</span>
                }
                case MvBook -&gt; {
<span class="nc" id="L265">                    return Localization.lang(&quot;A multi-volume \&quot;Book\&quot;.&quot;);</span>
                }
                case MvCollection -&gt; {
<span class="nc" id="L268">                    return Localization.lang(&quot;A multi-volume \&quot;Collection\&quot;.&quot;);</span>
                }
                case MvProceedings -&gt; {
<span class="nc" id="L271">                    return Localization.lang(&quot;A multi-volume \&quot;Proceedings\&quot; entry.&quot;);</span>
                }
                case MvReference -&gt; {
<span class="nc" id="L274">                    return Localization.lang(&quot;A multi-volume \&quot;Reference\&quot; entry. The standard styles will treat this entry type as an alias for \&quot;MvCollection\&quot;.&quot;);</span>
                }
                case Online -&gt; {
<span class="nc" id="L277">                    return Localization.lang(&quot;This entry type is intended for sources such as web sites which are intrinsically online resources.&quot;);</span>
                }
                case Reference -&gt; {
<span class="nc" id="L280">                    return Localization.lang(&quot;A single-volume work of reference such as an encyclopedia or a dictionary.&quot;);</span>
                }
                case Report -&gt; {
<span class="nc" id="L283">                    return Localization.lang(&quot;A technical report, research report, or white paper published by a university or some other institution.&quot;);</span>
                }
                case Set -&gt; {
<span class="nc" id="L286">                    return Localization.lang(&quot;An entry set is a group of entries which are cited as a single reference and listed as a single item in the bibliography.&quot;);</span>
                }
                case SuppBook -&gt; {
<span class="nc" id="L289">                    return Localization.lang(&quot;Supplemental material in a \&quot;Book\&quot;. This type is provided for elements such as prefaces, introductions, forewords, afterwords, etc. which often have a generic title only.&quot;);</span>
                }
                case SuppCollection -&gt; {
<span class="nc" id="L292">                    return Localization.lang(&quot;Supplemental material in a \&quot;Collection\&quot;.&quot;);</span>
                }
                case SuppPeriodical -&gt; {
<span class="nc" id="L295">                    return Localization.lang(&quot;Supplemental material in a \&quot;Periodical\&quot;. This type may be useful when referring to items such as regular columns, obituaries, letters to the editor, etc. which only have a generic title.&quot;);</span>
                }
                case Thesis -&gt; {
<span class="nc" id="L298">                    return Localization.lang(&quot;A thesis written for an educational institution to satisfy the requirements for a degree.&quot;);</span>
                }
                case WWW -&gt; {
<span class="nc" id="L301">                    return Localization.lang(&quot;An alias for \&quot;Online\&quot;, provided for jurabib compatibility.&quot;);</span>
                }
                case Software -&gt; {
<span class="nc" id="L304">                    return Localization.lang(&quot;Computer software. The standard styles will treat this entry type as an alias for \&quot;Misc\&quot;.&quot;);</span>
                }
                case Dataset -&gt; {
<span class="nc" id="L307">                    return Localization.lang(&quot;A data set or a similar collection of (mostly) raw data.&quot;);</span>
                }
                default -&gt; {
<span class="nc" id="L310">                    return &quot;&quot;;</span>
                }
            }
        } else {
<span class="nc" id="L314">            return &quot;&quot;;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>