<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LayoutHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JabRef</a> &gt; <a href="index.source.html" class="el_package">org.jabref.logic.layout</a> &gt; <span class="el_source">LayoutHelper.java</span></div><h1>LayoutHelper.java</h1><pre class="source lang-java linenums">package org.jabref.logic.layout;

import java.io.IOException;
import java.io.PushbackReader;
import java.io.Reader;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.Objects;

/**
 * Helper class to get a Layout object.
 *
 * &lt;pre&gt;
 * &lt;code&gt;
 * LayoutHelper helper = new LayoutHelper(...a reader...);
 * Layout layout = helper.getLayoutFromText();
 * &lt;/code&gt;
 * &lt;/pre&gt;
 */
public class LayoutHelper {

    public static final int IS_LAYOUT_TEXT = 1;
    public static final int IS_SIMPLE_COMMAND = 2;
    public static final int IS_FIELD_START = 3;
    public static final int IS_FIELD_END = 4;
    public static final int IS_OPTION_FIELD = 5;
    public static final int IS_GROUP_START = 6;
    public static final int IS_GROUP_END = 7;
    public static final int IS_ENCODING_NAME = 8;
    public static final int IS_FILENAME = 9;
    public static final int IS_FILEPATH = 10;

    private static String currentGroup;

    private final PushbackReader in;
<span class="fc" id="L37">    private final List&lt;StringInt&gt; parsedEntries = new ArrayList&lt;&gt;();</span>
    private final LayoutFormatterPreferences prefs;
    private boolean endOfFile;

<span class="fc" id="L41">    public LayoutHelper(Reader in, LayoutFormatterPreferences prefs) {</span>
<span class="fc" id="L42">        this.in = new PushbackReader(Objects.requireNonNull(in));</span>
<span class="fc" id="L43">        this.prefs = Objects.requireNonNull(prefs);</span>
<span class="fc" id="L44">    }</span>

    public Layout getLayoutFromText() throws IOException {
<span class="fc" id="L47">        parse();</span>

<span class="fc bfc" id="L49" title="All 2 branches covered.">        for (StringInt parsedEntry : parsedEntries) {</span>
<span class="pc bpc" id="L50" title="2 of 10 branches missed.">            if ((parsedEntry.i == LayoutHelper.IS_SIMPLE_COMMAND) || (parsedEntry.i == LayoutHelper.IS_FIELD_START)</span>
                    || (parsedEntry.i == LayoutHelper.IS_FIELD_END) || (parsedEntry.i == LayoutHelper.IS_GROUP_START)
                    || (parsedEntry.i == LayoutHelper.IS_GROUP_END)) {
<span class="fc" id="L53">                parsedEntry.s = parsedEntry.s.trim().toLowerCase(Locale.ROOT);</span>
            }
<span class="fc" id="L55">        }</span>

<span class="fc" id="L57">        return new Layout(parsedEntries, prefs);</span>
    }

    public static String getCurrentGroup() {
<span class="nc" id="L61">        return LayoutHelper.currentGroup;</span>
    }

    public static void setCurrentGroup(String newGroup) {
<span class="nc" id="L65">        LayoutHelper.currentGroup = newGroup;</span>
<span class="nc" id="L66">    }</span>

    private void doBracketedField(final int field) throws IOException {
<span class="fc" id="L69">        StringBuilder buffer = null;</span>
        int currentCharacter;
<span class="fc" id="L71">        boolean start = false;</span>

<span class="pc bpc" id="L73" title="1 of 2 branches missed.">        while (!endOfFile) {</span>
<span class="fc" id="L74">            currentCharacter = read();</span>

<span class="pc bpc" id="L76" title="1 of 2 branches missed.">            if (currentCharacter == -1) {</span>
<span class="nc" id="L77">                endOfFile = true;</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc" id="L79">                    parsedEntries.add(new StringInt(buffer.toString(), field));</span>
                }
<span class="nc" id="L81">                return;</span>
            }

<span class="fc bfc" id="L84" title="All 4 branches covered.">            if ((currentCharacter == '{') || (currentCharacter == '}')) {</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">                if (currentCharacter == '}') {</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">                    if (buffer != null) {</span>
<span class="fc" id="L87">                        parsedEntries.add(new StringInt(buffer.toString(), field));</span>
<span class="fc" id="L88">                        return;</span>
                    }
                } else {
<span class="fc" id="L91">                    start = true;</span>
                }
            } else {
<span class="fc bfc" id="L94" title="All 2 branches covered.">                if (buffer == null) {</span>
<span class="fc" id="L95">                    buffer = new StringBuilder(100);</span>
                }

<span class="pc bpc" id="L98" title="2 of 4 branches missed.">                if (start &amp;&amp; (currentCharacter != '}')) {</span>
<span class="fc" id="L99">                    buffer.append((char) currentCharacter);</span>
                }
            }
        }
<span class="nc" id="L103">    }</span>

    private void doBracketedOptionField() throws IOException {
<span class="fc" id="L106">        StringBuilder buffer = null;</span>
        int c;
<span class="fc" id="L108">        boolean start = false;</span>
<span class="fc" id="L109">        boolean inQuotes = false;</span>
<span class="fc" id="L110">        boolean doneWithOptions = false;</span>
<span class="fc" id="L111">        String option = null;</span>
        String tmp;

<span class="pc bpc" id="L114" title="1 of 2 branches missed.">        while (!endOfFile) {</span>
<span class="fc" id="L115">            c = read();</span>

<span class="pc bpc" id="L117" title="1 of 2 branches missed.">            if (c == -1) {</span>
<span class="nc" id="L118">                endOfFile = true;</span>

<span class="nc bnc" id="L120" title="All 2 branches missed.">                if (buffer != null) {</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">                    if (option == null) {</span>
<span class="nc" id="L122">                        tmp = buffer.toString();</span>
                    } else {
<span class="nc" id="L124">                        tmp = buffer.toString() + '\n' + option;</span>
                    }

<span class="nc" id="L127">                    parsedEntries.add(new StringInt(tmp, LayoutHelper.IS_OPTION_FIELD));</span>
                }

<span class="nc" id="L130">                return;</span>
            }
<span class="fc bfc" id="L132" title="All 12 branches covered.">            if (!inQuotes &amp;&amp; ((c == ']') || (c == '[') || (doneWithOptions &amp;&amp; ((c == '{') || (c == '}'))))) {</span>
<span class="fc bfc" id="L133" title="All 6 branches covered.">                if ((c == ']') || (doneWithOptions &amp;&amp; (c == '}'))) {</span>
                    // changed section start - arudert
                    // buffer may be null for parameters
<span class="pc bpc" id="L136" title="1 of 4 branches missed.">                    if ((c == ']') &amp;&amp; (buffer != null)) {</span>
                        // changed section end - arudert
<span class="fc" id="L138">                        option = buffer.toString();</span>
<span class="fc" id="L139">                        buffer = null;</span>
<span class="fc" id="L140">                        start = false;</span>
<span class="fc" id="L141">                        doneWithOptions = true;</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">                    } else if (c == '}') {</span>
                        // changed section begin - arudert
                        // bracketed option must be followed by an (optionally empty) parameter
                        // if empty, the parameter is set to &quot; &quot; (whitespace to avoid that the tokenizer that
                        // splits the string later on ignores the empty parameter)
<span class="fc bfc" id="L147" title="All 2 branches covered.">                        String parameter = buffer == null ? &quot; &quot; : buffer.toString();</span>
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">                        if (option == null) {</span>
<span class="nc" id="L149">                            tmp = parameter;</span>
                        } else {
<span class="fc" id="L151">                            tmp = parameter + '\n' + option;</span>
                        }

<span class="fc" id="L154">                        parsedEntries.add(new StringInt(tmp, LayoutHelper.IS_OPTION_FIELD));</span>

<span class="fc" id="L156">                        return;</span>
                    }
                    // changed section end - arudert
                    // changed section start - arudert
                    // }
                    // changed section end - arudert
                } else {
<span class="fc" id="L163">                    start = true;</span>
                }
<span class="fc bfc" id="L165" title="All 2 branches covered.">            } else if (c == '&quot;') {</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">                inQuotes = !inQuotes;</span>

<span class="pc bpc" id="L168" title="1 of 2 branches missed.">                if (buffer == null) {</span>
<span class="nc" id="L169">                    buffer = new StringBuilder(100);</span>
                }
<span class="fc" id="L171">                buffer.append('&quot;');</span>
            } else {
<span class="fc bfc" id="L173" title="All 2 branches covered.">                if (buffer == null) {</span>
<span class="fc" id="L174">                    buffer = new StringBuilder(100);</span>
                }

<span class="pc bpc" id="L177" title="1 of 2 branches missed.">                if (start) {</span>

                    // changed section begin - arudert
                    // keep the backslash so we know wether this is a fieldname or an ordinary parameter
                    // if (c != '\\') {
<span class="fc" id="L182">                    buffer.append((char) c);</span>
                    // }
                    // changed section end - arudert

                }
            }
        }
<span class="nc" id="L189">    }</span>

    private void parse() throws IOException {
<span class="fc" id="L192">        skipWhitespace();</span>

        int c;

<span class="fc" id="L196">        StringBuilder buffer = null;</span>
<span class="fc" id="L197">        boolean escaped = false;</span>

<span class="fc bfc" id="L199" title="All 2 branches covered.">        while (!endOfFile) {</span>
<span class="fc" id="L200">            c = read();</span>

<span class="fc bfc" id="L202" title="All 2 branches covered.">            if (c == -1) {</span>
<span class="fc" id="L203">                endOfFile = true;</span>

                // Check for null, otherwise a Layout that finishes with a curly brace throws a NPE
<span class="fc bfc" id="L206" title="All 2 branches covered.">                if (buffer != null) {</span>
<span class="fc" id="L207">                    parsedEntries.add(new StringInt(buffer.toString(), LayoutHelper.IS_LAYOUT_TEXT));</span>
                }

<span class="fc" id="L210">                return;</span>
            }

<span class="pc bpc" id="L213" title="2 of 6 branches missed.">            if ((c == '\\') &amp;&amp; (peek() != '\\') &amp;&amp; !escaped) {</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">                if (buffer != null) {</span>
<span class="fc" id="L215">                    parsedEntries.add(new StringInt(buffer.toString(), LayoutHelper.IS_LAYOUT_TEXT));</span>

<span class="fc" id="L217">                    buffer = null;</span>
                }

<span class="fc" id="L220">                parseField();</span>

                // To make sure the next character, if it is a backslash,
                // doesn't get ignored, since &quot;previous&quot; now holds a backslash:
<span class="fc" id="L224">                escaped = false;</span>
            } else {
<span class="fc bfc" id="L226" title="All 2 branches covered.">                if (buffer == null) {</span>
<span class="fc" id="L227">                    buffer = new StringBuilder(100);</span>
                }

<span class="pc bpc" id="L230" title="3 of 4 branches missed.">                if ((c != '\\') || escaped) /* (previous == '\\'))) */ {</span>
<span class="fc" id="L231">                    buffer.append((char) c);</span>
                }

<span class="pc bpc" id="L234" title="3 of 4 branches missed.">                escaped = (c == '\\') &amp;&amp; !escaped;</span>
            }
        }
<span class="fc" id="L237">    }</span>

    private void parseField() throws IOException {
        int c;
<span class="fc" id="L241">        StringBuilder buffer = null;</span>
        String name;

<span class="pc bpc" id="L244" title="1 of 2 branches missed.">        while (!endOfFile) {</span>
<span class="fc" id="L245">            c = read();</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">            if (c == -1) {</span>
<span class="fc" id="L247">                endOfFile = true;</span>
            }

<span class="pc bpc" id="L250" title="1 of 4 branches missed.">            if (!Character.isLetter((char) c) &amp;&amp; (c != '_')) {</span>
<span class="fc" id="L251">                unread(c);</span>

<span class="fc bfc" id="L253" title="All 2 branches covered.">                name = buffer == null ? &quot;&quot; : buffer.toString();</span>

<span class="fc bfc" id="L255" title="All 2 branches covered.">                if (name.isEmpty()) {</span>
<span class="fc" id="L256">                    StringBuilder lastFive = new StringBuilder(10);</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">                    if (parsedEntries.isEmpty()) {</span>
<span class="fc" id="L258">                        lastFive.append(&quot;unknown&quot;);</span>
                    } else {
<span class="nc bnc" id="L260" title="All 2 branches missed.">                        for (StringInt entry : parsedEntries.subList(Math.max(0, parsedEntries.size() - 6),</span>
<span class="nc" id="L261">                                parsedEntries.size() - 1)) {</span>
<span class="nc" id="L262">                            lastFive.append(entry.s);</span>
<span class="nc" id="L263">                        }</span>
                    }
<span class="fc" id="L265">                    throw new IOException(</span>
<span class="fc" id="L266">                            &quot;Backslash parsing error near \'&quot; + lastFive.toString().replace(&quot;\n&quot;, &quot; &quot;) + '\'');</span>
                }

<span class="fc bfc" id="L269" title="All 2 branches covered.">                if (&quot;begin&quot;.equalsIgnoreCase(name)) {</span>
                    // get field name
<span class="fc" id="L271">                    doBracketedField(LayoutHelper.IS_FIELD_START);</span>

<span class="fc" id="L273">                    return;</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">                } else if (&quot;begingroup&quot;.equalsIgnoreCase(name)) {</span>
                    // get field name
<span class="nc" id="L276">                    doBracketedField(LayoutHelper.IS_GROUP_START);</span>
<span class="nc" id="L277">                    return;</span>
<span class="fc bfc" id="L278" title="All 2 branches covered.">                } else if (&quot;format&quot;.equalsIgnoreCase(name)) {</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">                    if (c == '[') {</span>
                        // get format parameter
                        // get field name
<span class="fc" id="L282">                        doBracketedOptionField();</span>

<span class="fc" id="L284">                        return;</span>
                    } else {
                        // get field name
<span class="nc" id="L287">                        doBracketedField(LayoutHelper.IS_OPTION_FIELD);</span>

<span class="nc" id="L289">                        return;</span>
                    }
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">                } else if (&quot;filename&quot;.equalsIgnoreCase(name)) {</span>
                    // Print the name of the database BIB file.
                    // This is only supported in begin/end layouts, not in
                    // entry layouts.
<span class="nc" id="L295">                    parsedEntries.add(new StringInt(name, LayoutHelper.IS_FILENAME));</span>
<span class="nc" id="L296">                    return;</span>
<span class="pc bpc" id="L297" title="1 of 2 branches missed.">                } else if (&quot;filepath&quot;.equalsIgnoreCase(name)) {</span>
                    // Print the full path of the database BIB file.
                    // This is only supported in begin/end layouts, not in
                    // entry layouts.
<span class="nc" id="L301">                    parsedEntries.add(new StringInt(name, LayoutHelper.IS_FILEPATH));</span>
<span class="nc" id="L302">                    return;</span>
<span class="fc bfc" id="L303" title="All 2 branches covered.">                } else if (&quot;end&quot;.equalsIgnoreCase(name)) {</span>
                    // get field name
<span class="fc" id="L305">                    doBracketedField(LayoutHelper.IS_FIELD_END);</span>
<span class="fc" id="L306">                    return;</span>
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">                } else if (&quot;endgroup&quot;.equalsIgnoreCase(name)) {</span>
                    // get field name
<span class="nc" id="L309">                    doBracketedField(LayoutHelper.IS_GROUP_END);</span>
<span class="nc" id="L310">                    return;</span>
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">                } else if (&quot;encoding&quot;.equalsIgnoreCase(name)) {</span>
                    // Print the name of the current encoding used for export.
                    // This is only supported in begin/end layouts, not in
                    // entry layouts.
<span class="nc" id="L315">                    parsedEntries.add(new StringInt(name, LayoutHelper.IS_ENCODING_NAME));</span>
<span class="nc" id="L316">                    return;</span>
                }

                // for all other cases -&gt; simple command
<span class="fc" id="L320">                parsedEntries.add(new StringInt(name, LayoutHelper.IS_SIMPLE_COMMAND));</span>

<span class="fc" id="L322">                return;</span>
            } else {
<span class="fc bfc" id="L324" title="All 2 branches covered.">                if (buffer == null) {</span>
<span class="fc" id="L325">                    buffer = new StringBuilder(100);</span>
                }

<span class="fc" id="L328">                buffer.append((char) c);</span>
            }
        }
<span class="nc" id="L331">    }</span>

    private int peek() throws IOException {
<span class="fc" id="L334">        int c = read();</span>
<span class="fc" id="L335">        unread(c);</span>

<span class="fc" id="L337">        return c;</span>
    }

    private int read() throws IOException {
<span class="fc" id="L341">        return in.read();</span>
    }

    private void skipWhitespace() throws IOException {
        int c;

        while (true) {
<span class="fc" id="L348">            c = read();</span>

<span class="pc bpc" id="L350" title="2 of 4 branches missed.">            if ((c == -1) || (c == 65535)) {</span>
<span class="nc" id="L351">                endOfFile = true;</span>

<span class="nc" id="L353">                return;</span>
            }

<span class="fc bfc" id="L356" title="All 2 branches covered.">            if (!Character.isWhitespace((char) c)) {</span>
<span class="fc" id="L357">                unread(c);</span>
<span class="fc" id="L358">                break;</span>
            }
        }
<span class="fc" id="L361">    }</span>

    private void unread(int c) throws IOException {
<span class="fc" id="L364">        in.unread(c);</span>
<span class="fc" id="L365">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>