<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CopyMoreAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JabRef</a> &gt; <a href="index.source.html" class="el_package">org.jabref.gui.edit</a> &gt; <span class="el_source">CopyMoreAction.java</span></div><h1>CopyMoreAction.java</h1><pre class="source lang-java linenums">package org.jabref.gui.edit;

import java.io.IOException;
import java.io.StringReader;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import org.jabref.gui.ClipBoardManager;
import org.jabref.gui.DialogService;
import org.jabref.gui.Globals;
import org.jabref.gui.JabRefDialogService;
import org.jabref.gui.StateManager;
import org.jabref.gui.actions.ActionHelper;
import org.jabref.gui.actions.SimpleCommand;
import org.jabref.gui.actions.StandardActions;
import org.jabref.logic.l10n.Localization;
import org.jabref.logic.layout.Layout;
import org.jabref.logic.layout.LayoutHelper;
import org.jabref.logic.util.OS;
import org.jabref.model.entry.BibEntry;
import org.jabref.model.entry.field.StandardField;
import org.jabref.preferences.PreferencesService;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class CopyMoreAction extends SimpleCommand {

<span class="fc" id="L30">    private static final Logger LOGGER = LoggerFactory.getLogger(CopyMoreAction.class);</span>
    private final StandardActions action;
    private final DialogService dialogService;
    private final StateManager stateManager;
    private final ClipBoardManager clipBoardManager;
    private final PreferencesService preferencesService;

    public CopyMoreAction(StandardActions action,
                          DialogService dialogService,
                          StateManager stateManager,
                          ClipBoardManager clipBoardManager,
<span class="fc" id="L41">                          PreferencesService preferencesService) {</span>
<span class="fc" id="L42">        this.action = action;</span>
<span class="fc" id="L43">        this.dialogService = dialogService;</span>
<span class="fc" id="L44">        this.stateManager = stateManager;</span>
<span class="fc" id="L45">        this.clipBoardManager = clipBoardManager;</span>
<span class="fc" id="L46">        this.preferencesService = preferencesService;</span>

<span class="fc" id="L48">        this.executable.bind(ActionHelper.needsEntriesSelected(stateManager));</span>
<span class="fc" id="L49">    }</span>

    @Override
    public void execute() {
<span class="pc bpc" id="L53" title="1 of 4 branches missed.">        if (stateManager.getActiveDatabase().isEmpty() || stateManager.getSelectedEntries().isEmpty()) {</span>
<span class="fc" id="L54">            return;</span>
        }

<span class="pc bpc" id="L57" title="4 of 7 branches missed.">        switch (action) {</span>
<span class="fc" id="L58">            case COPY_TITLE -&gt; copyTitle();</span>
<span class="fc" id="L59">            case COPY_KEY -&gt; copyKey();</span>
<span class="nc" id="L60">            case COPY_CITE_KEY -&gt; copyCiteKey();</span>
<span class="nc" id="L61">            case COPY_KEY_AND_TITLE -&gt; copyKeyAndTitle();</span>
<span class="nc" id="L62">            case COPY_KEY_AND_LINK -&gt; copyKeyAndLink();</span>
<span class="fc" id="L63">            case COPY_DOI, COPY_DOI_URL -&gt; copyDoi();</span>
<span class="nc" id="L64">            default -&gt; LOGGER.info(&quot;Unknown copy command.&quot;);</span>
        }
<span class="fc" id="L66">    }</span>

    private void copyTitle() {
<span class="fc" id="L69">        List&lt;BibEntry&gt; selectedBibEntries = stateManager.getSelectedEntries();</span>

<span class="fc" id="L71">        List&lt;String&gt; titles = selectedBibEntries.stream()</span>
<span class="fc" id="L72">                                                .filter(bibEntry -&gt; bibEntry.getTitle().isPresent())</span>
<span class="fc" id="L73">                                                .map(bibEntry -&gt; bibEntry.getTitle().get())</span>
<span class="fc" id="L74">                                                .collect(Collectors.toList());</span>

<span class="fc bfc" id="L76" title="All 2 branches covered.">        if (titles.isEmpty()) {</span>
<span class="fc" id="L77">            dialogService.notify(Localization.lang(&quot;None of the selected entries have titles.&quot;));</span>
<span class="fc" id="L78">            return;</span>
        }

<span class="fc" id="L81">        final String copiedTitles = String.join(&quot;\n&quot;, titles);</span>
<span class="fc" id="L82">        clipBoardManager.setContent(copiedTitles);</span>

<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (titles.size() == selectedBibEntries.size()) {</span>
            // All entries had titles.
<span class="fc" id="L86">            dialogService.notify(Localization.lang(&quot;Copied '%0' to clipboard.&quot;,</span>
<span class="fc" id="L87">                    JabRefDialogService.shortenDialogMessage(copiedTitles)));</span>
        } else {
<span class="fc" id="L89">            dialogService.notify(Localization.lang(&quot;Warning: %0 out of %1 entries have undefined title.&quot;,</span>
<span class="fc" id="L90">                    Integer.toString(selectedBibEntries.size() - titles.size()), Integer.toString(selectedBibEntries.size())));</span>
        }
<span class="fc" id="L92">    }</span>

    private void copyKey() {
<span class="fc" id="L95">        List&lt;BibEntry&gt; entries = stateManager.getSelectedEntries();</span>

        // Collect all non-null keys.
<span class="fc" id="L98">        List&lt;String&gt; keys = entries.stream()</span>
<span class="fc" id="L99">                                   .filter(entry -&gt; entry.getCitationKey().isPresent())</span>
<span class="fc" id="L100">                                   .map(entry -&gt; entry.getCitationKey().get())</span>
<span class="fc" id="L101">                                   .collect(Collectors.toList());</span>

<span class="fc bfc" id="L103" title="All 2 branches covered.">        if (keys.isEmpty()) {</span>
<span class="fc" id="L104">            dialogService.notify(Localization.lang(&quot;None of the selected entries have citation keys.&quot;));</span>
<span class="fc" id="L105">            return;</span>
        }

<span class="fc" id="L108">        final String copiedKeys = String.join(&quot;,&quot;, keys);</span>
<span class="fc" id="L109">        clipBoardManager.setContent(copiedKeys);</span>

<span class="fc bfc" id="L111" title="All 2 branches covered.">        if (keys.size() == entries.size()) {</span>
            // All entries had keys.
<span class="fc" id="L113">            dialogService.notify(Localization.lang(&quot;Copied '%0' to clipboard.&quot;,</span>
<span class="fc" id="L114">                    JabRefDialogService.shortenDialogMessage(copiedKeys)));</span>
        } else {
<span class="fc" id="L116">            dialogService.notify(Localization.lang(&quot;Warning: %0 out of %1 entries have undefined citation key.&quot;,</span>
<span class="fc" id="L117">                    Integer.toString(entries.size() - keys.size()), Integer.toString(entries.size())));</span>
        }
<span class="fc" id="L119">    }</span>

    private void copyDoi() {
<span class="fc" id="L122">        List&lt;BibEntry&gt; entries = stateManager.getSelectedEntries();</span>

        // Collect all non-null DOI or DOI urls
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if (action == StandardActions.COPY_DOI_URL) {</span>
<span class="nc" id="L126">            copyDoiList(entries.stream()</span>
<span class="nc" id="L127">                    .filter(entry -&gt; entry.getDOI().isPresent())</span>
<span class="nc" id="L128">                    .map(entry -&gt; entry.getDOI().get().getURIAsASCIIString())</span>
<span class="nc" id="L129">                    .collect(Collectors.toList()), entries.size());</span>
        } else {
<span class="fc" id="L131">            copyDoiList(entries.stream()</span>
<span class="fc" id="L132">                    .filter(entry -&gt; entry.getDOI().isPresent())</span>
<span class="fc" id="L133">                    .map(entry -&gt; entry.getDOI().get().getDOI())</span>
<span class="fc" id="L134">                    .collect(Collectors.toList()), entries.size());</span>
        }
<span class="fc" id="L136">    }</span>

    private void copyDoiList(List&lt;String&gt; dois, int size) {
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (dois.isEmpty()) {</span>
<span class="fc" id="L140">            dialogService.notify(Localization.lang(&quot;None of the selected entries have DOIs.&quot;));</span>
<span class="fc" id="L141">            return;</span>
        }

<span class="fc" id="L144">        final String copiedDois = String.join(&quot;,&quot;, dois);</span>
<span class="fc" id="L145">        clipBoardManager.setContent(copiedDois);</span>

<span class="fc bfc" id="L147" title="All 2 branches covered.">        if (dois.size() == size) {</span>
            // All entries had DOIs.
<span class="fc" id="L149">            dialogService.notify(Localization.lang(&quot;Copied '%0' to clipboard.&quot;,</span>
<span class="fc" id="L150">                    JabRefDialogService.shortenDialogMessage(copiedDois)));</span>
        } else {
<span class="fc" id="L152">            dialogService.notify(Localization.lang(&quot;Warning: %0 out of %1 entries have undefined DOIs.&quot;,</span>
<span class="fc" id="L153">                    Integer.toString(size - dois.size()), Integer.toString(size)));</span>
        }
<span class="fc" id="L155">    }</span>

    private void copyCiteKey() {
<span class="nc" id="L158">        List&lt;BibEntry&gt; entries = stateManager.getSelectedEntries();</span>

        // Collect all non-null keys.
<span class="nc" id="L161">        List&lt;String&gt; keys = entries.stream()</span>
<span class="nc" id="L162">                                   .filter(entry -&gt; entry.getCitationKey().isPresent())</span>
<span class="nc" id="L163">                                   .map(entry -&gt; entry.getCitationKey().get())</span>
<span class="nc" id="L164">                                   .collect(Collectors.toList());</span>

<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (keys.isEmpty()) {</span>
<span class="nc" id="L167">            dialogService.notify(Localization.lang(&quot;None of the selected entries have citation keys.&quot;));</span>
<span class="nc" id="L168">            return;</span>
        }

<span class="nc" id="L171">        String citeCommand = Optional.ofNullable(preferencesService.getExternalApplicationsPreferences().getCiteCommand())</span>
<span class="nc" id="L172">                                     .filter(cite -&gt; cite.contains(&quot;\\&quot;)) // must contain \</span>
<span class="nc" id="L173">                                     .orElse(&quot;\\cite&quot;);</span>

<span class="nc" id="L175">        final String copiedCiteCommand = citeCommand + &quot;{&quot; + String.join(&quot;,&quot;, keys) + '}';</span>
<span class="nc" id="L176">        clipBoardManager.setContent(copiedCiteCommand);</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (keys.size() == entries.size()) {</span>
            // All entries had keys.
<span class="nc" id="L180">            dialogService.notify(Localization.lang(&quot;Copied '%0' to clipboard.&quot;,</span>
<span class="nc" id="L181">                    JabRefDialogService.shortenDialogMessage(copiedCiteCommand)));</span>
        } else {
<span class="nc" id="L183">            dialogService.notify(Localization.lang(&quot;Warning: %0 out of %1 entries have undefined citation key.&quot;,</span>
<span class="nc" id="L184">                    Integer.toString(entries.size() - keys.size()), Integer.toString(entries.size())));</span>
        }
<span class="nc" id="L186">    }</span>

    private void copyKeyAndTitle() {
<span class="nc" id="L189">        List&lt;BibEntry&gt; entries = stateManager.getSelectedEntries();</span>

        // ToDo: this string should be configurable to allow arbitrary exports
<span class="nc" id="L192">        StringReader layoutString = new StringReader(&quot;\\citationkey - \\begin{title}\\format[RemoveBrackets]{\\title}\\end{title}\n&quot;);</span>
        Layout layout;
        try {
<span class="nc" id="L195">            layout = new LayoutHelper(layoutString, preferencesService.getLayoutFormatterPreferences(Globals.journalAbbreviationRepository)).getLayoutFromText();</span>
<span class="nc" id="L196">        } catch (IOException e) {</span>
<span class="nc" id="L197">            LOGGER.info(&quot;Could not get layout.&quot;, e);</span>
<span class="nc" id="L198">            return;</span>
<span class="nc" id="L199">        }</span>

<span class="nc" id="L201">        StringBuilder keyAndTitle = new StringBuilder();</span>

<span class="nc" id="L203">        int entriesWithKeys = 0;</span>
        // Collect all non-null keys.
<span class="nc bnc" id="L205" title="All 2 branches missed.">        for (BibEntry entry : entries) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            if (entry.hasCitationKey()) {</span>
<span class="nc" id="L207">                entriesWithKeys++;</span>
<span class="nc" id="L208">                keyAndTitle.append(layout.doLayout(entry, stateManager.getActiveDatabase().get().getDatabase()));</span>
            }
<span class="nc" id="L210">        }</span>

<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (entriesWithKeys == 0) {</span>
<span class="nc" id="L213">            dialogService.notify(Localization.lang(&quot;None of the selected entries have citation keys.&quot;));</span>
<span class="nc" id="L214">            return;</span>
        }

<span class="nc" id="L217">        clipBoardManager.setContent(keyAndTitle.toString());</span>

<span class="nc bnc" id="L219" title="All 2 branches missed.">        if (entriesWithKeys == entries.size()) {</span>
            // All entries had keys.
<span class="nc" id="L221">            dialogService.notify(Localization.lang(&quot;Copied '%0' to clipboard.&quot;,</span>
<span class="nc" id="L222">                    JabRefDialogService.shortenDialogMessage(keyAndTitle.toString())));</span>
        } else {
<span class="nc" id="L224">            dialogService.notify(Localization.lang(&quot;Warning: %0 out of %1 entries have undefined citation key.&quot;,</span>
<span class="nc" id="L225">                    Integer.toString(entries.size() - entriesWithKeys), Integer.toString(entries.size())));</span>
        }
<span class="nc" id="L227">    }</span>

    /**
     * This method will copy each selected entry's citation key as a hyperlink to its url to the clipboard. In case an
     * entry doesn't have a citation key it will not be copied. In case an entry doesn't have an url this will only copy
     * the citation key.
     */
    private void copyKeyAndLink() {
<span class="nc" id="L235">        List&lt;BibEntry&gt; entries = stateManager.getSelectedEntries();</span>

<span class="nc" id="L237">        StringBuilder keyAndLink = new StringBuilder();</span>
<span class="nc" id="L238">        StringBuilder fallbackString = new StringBuilder();</span>

<span class="nc" id="L240">        List&lt;BibEntry&gt; entriesWithKey = entries.stream()</span>
<span class="nc" id="L241">                                               .filter(BibEntry::hasCitationKey)</span>
<span class="nc" id="L242">                                               .collect(Collectors.toList());</span>

<span class="nc bnc" id="L244" title="All 2 branches missed.">        if (entriesWithKey.isEmpty()) {</span>
<span class="nc" id="L245">            dialogService.notify(Localization.lang(&quot;None of the selected entries have citation keys.&quot;));</span>
<span class="nc" id="L246">            return;</span>
        }

<span class="nc bnc" id="L249" title="All 2 branches missed.">        for (BibEntry entry : entriesWithKey) {</span>
<span class="nc" id="L250">            String key = entry.getCitationKey().get();</span>
<span class="nc" id="L251">            String url = entry.getField(StandardField.URL).orElse(&quot;&quot;);</span>
<span class="nc bnc" id="L252" title="All 2 branches missed.">            keyAndLink.append(url.isEmpty() ? key : String.format(&quot;&lt;a href=\&quot;%s\&quot;&gt;%s&lt;/a&gt;&quot;, url, key));</span>
<span class="nc" id="L253">            keyAndLink.append(OS.NEWLINE);</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">            fallbackString.append(url.isEmpty() ? key : String.format(&quot;%s - %s&quot;, key, url));</span>
<span class="nc" id="L255">            fallbackString.append(OS.NEWLINE);</span>
<span class="nc" id="L256">        }</span>

<span class="nc" id="L258">        clipBoardManager.setHtmlContent(keyAndLink.toString(), fallbackString.toString());</span>

<span class="nc bnc" id="L260" title="All 2 branches missed.">        if (entriesWithKey.size() == entries.size()) {</span>
            // All entries had keys.
<span class="nc" id="L262">            dialogService.notify(Localization.lang(&quot;Copied '%0' to clipboard.&quot;,</span>
<span class="nc" id="L263">                    JabRefDialogService.shortenDialogMessage(keyAndLink.toString())));</span>
        } else {
<span class="nc" id="L265">            dialogService.notify(Localization.lang(&quot;Warning: %0 out of %1 entries have undefined citation key.&quot;,</span>
<span class="nc" id="L266">                    Long.toString(entries.size() - entriesWithKey.size()), Integer.toString(entries.size())));</span>
        }
<span class="nc" id="L268">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>