<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MainTableColumnFactory.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JabRef</a> &gt; <a href="index.source.html" class="el_package">org.jabref.gui.maintable</a> &gt; <span class="el_source">MainTableColumnFactory.java</span></div><h1>MainTableColumnFactory.java</h1><pre class="source lang-java linenums">package org.jabref.gui.maintable;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.stream.Collectors;

import javax.swing.undo.UndoManager;

import javafx.beans.property.ReadOnlyObjectWrapper;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Node;
import javafx.scene.control.TableColumn;
import javafx.scene.control.Tooltip;
import javafx.scene.layout.HBox;
import javafx.scene.layout.Pane;
import javafx.scene.paint.Color;
import javafx.scene.shape.Rectangle;
import javafx.scene.text.Text;

import org.jabref.gui.DialogService;
import org.jabref.gui.StateManager;
import org.jabref.gui.externalfiletype.ExternalFileTypes;
import org.jabref.gui.icon.IconTheme;
import org.jabref.gui.maintable.columns.FieldColumn;
import org.jabref.gui.maintable.columns.FileColumn;
import org.jabref.gui.maintable.columns.LibraryColumn;
import org.jabref.gui.maintable.columns.LinkedIdentifierColumn;
import org.jabref.gui.maintable.columns.MainTableColumn;
import org.jabref.gui.maintable.columns.SpecialFieldColumn;
import org.jabref.gui.specialfields.SpecialFieldValueViewModel;
import org.jabref.gui.util.ValueTableCellFactory;
import org.jabref.logic.l10n.Localization;
import org.jabref.model.database.BibDatabaseContext;
import org.jabref.model.entry.LinkedFile;
import org.jabref.model.entry.field.Field;
import org.jabref.model.entry.field.FieldFactory;
import org.jabref.model.entry.field.SpecialField;
import org.jabref.model.groups.AbstractGroup;
import org.jabref.model.util.OptionalUtil;
import org.jabref.preferences.PreferencesService;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class MainTableColumnFactory {

    public static final String STYLE_ICON_COLUMN = &quot;column-icon&quot;;

<span class="nc" id="L53">    private static final Logger LOGGER = LoggerFactory.getLogger(MainTableColumnFactory.class);</span>

    private final PreferencesService preferencesService;
    private final ColumnPreferences columnPreferences;
    private final ExternalFileTypes externalFileTypes;
    private final BibDatabaseContext database;
    private final CellFactory cellFactory;
    private final UndoManager undoManager;
    private final DialogService dialogService;
    private final StateManager stateManager;

    public MainTableColumnFactory(BibDatabaseContext database,
                                  PreferencesService preferencesService,
                                  ColumnPreferences abstractColumnPrefs,
                                  ExternalFileTypes externalFileTypes,
                                  UndoManager undoManager,
                                  DialogService dialogService,
<span class="nc" id="L70">                                  StateManager stateManager) {</span>
<span class="nc" id="L71">        this.database = Objects.requireNonNull(database);</span>
<span class="nc" id="L72">        this.preferencesService = Objects.requireNonNull(preferencesService);</span>
<span class="nc" id="L73">        this.columnPreferences = abstractColumnPrefs;</span>
<span class="nc" id="L74">        this.externalFileTypes = Objects.requireNonNull(externalFileTypes);</span>
<span class="nc" id="L75">        this.dialogService = dialogService;</span>
<span class="nc" id="L76">        this.cellFactory = new CellFactory(externalFileTypes, preferencesService, undoManager);</span>
<span class="nc" id="L77">        this.undoManager = undoManager;</span>
<span class="nc" id="L78">        this.stateManager = stateManager;</span>
<span class="nc" id="L79">    }</span>

    public List&lt;TableColumn&lt;BibEntryTableViewModel, ?&gt;&gt; createColumns() {
<span class="nc" id="L82">        List&lt;TableColumn&lt;BibEntryTableViewModel, ?&gt;&gt; columns = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L84">        columnPreferences.getColumns().forEach(column -&gt; {</span>

<span class="nc bnc" id="L86" title="All 8 branches missed.">            switch (column.getType()) {</span>
                case INDEX:
<span class="nc" id="L88">                    columns.add(createIndexColumn(column));</span>
<span class="nc" id="L89">                    break;</span>
                case GROUPS:
<span class="nc" id="L91">                    columns.add(createGroupColumn(column));</span>
<span class="nc" id="L92">                    break;</span>
                case FILES:
<span class="nc" id="L94">                    columns.add(createFilesColumn(column));</span>
<span class="nc" id="L95">                    break;</span>
                case LINKED_IDENTIFIER:
<span class="nc" id="L97">                    columns.add(createIdentifierColumn(column));</span>
<span class="nc" id="L98">                    break;</span>
                case LIBRARY_NAME:
<span class="nc" id="L100">                    columns.add(createLibraryColumn(column));</span>
<span class="nc" id="L101">                    break;</span>
                case EXTRAFILE:
<span class="nc bnc" id="L103" title="All 2 branches missed.">                    if (!column.getQualifier().isBlank()) {</span>
<span class="nc" id="L104">                        columns.add(createExtraFileColumn(column));</span>
                    }
                    break;
                case SPECIALFIELD:
<span class="nc bnc" id="L108" title="All 2 branches missed.">                    if (!column.getQualifier().isBlank()) {</span>
<span class="nc" id="L109">                        Field field = FieldFactory.parseField(column.getQualifier());</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">                        if (field instanceof SpecialField) {</span>
<span class="nc" id="L111">                            columns.add(createSpecialFieldColumn(column));</span>
                        } else {
<span class="nc" id="L113">                            LOGGER.warn(&quot;Special field type '{}' is unknown. Using normal column type.&quot;, column.getQualifier());</span>
<span class="nc" id="L114">                            columns.add(createFieldColumn(column));</span>
                        }
<span class="nc" id="L116">                    }</span>
                    break;
                default:
                case NORMALFIELD:
<span class="nc bnc" id="L120" title="All 2 branches missed.">                    if (!column.getQualifier().isBlank()) {</span>
<span class="nc" id="L121">                        columns.add(createFieldColumn(column));</span>
                    }
                    break;
            }
<span class="nc" id="L125">        });</span>

<span class="nc" id="L127">        return columns;</span>
    }

    public static void setExactWidth(TableColumn&lt;?, ?&gt; column, double width) {
<span class="nc" id="L131">        column.setMinWidth(width);</span>
<span class="nc" id="L132">        column.setPrefWidth(width);</span>
<span class="nc" id="L133">        column.setMaxWidth(width);</span>
<span class="nc" id="L134">    }</span>

    /**
     * Creates a column with a continous number
     */
    private TableColumn&lt;BibEntryTableViewModel, String&gt; createIndexColumn(MainTableColumnModel columnModel) {
<span class="nc" id="L140">        TableColumn&lt;BibEntryTableViewModel, String&gt; column = new MainTableColumn&lt;&gt;(columnModel);</span>
<span class="nc" id="L141">        Node header = new Text(&quot;#&quot;);</span>
<span class="nc" id="L142">        header.getStyleClass().add(&quot;mainTable-header&quot;);</span>
<span class="nc" id="L143">        Tooltip.install(header, new Tooltip(MainTableColumnModel.Type.INDEX.getDisplayName()));</span>
<span class="nc" id="L144">        column.setGraphic(header);</span>
<span class="nc" id="L145">        column.setStyle(&quot;-fx-alignment: CENTER-RIGHT;&quot;);</span>
<span class="nc" id="L146">        column.setCellValueFactory(cellData -&gt; new ReadOnlyObjectWrapper&lt;&gt;(</span>
<span class="nc" id="L147">                String.valueOf(cellData.getTableView().getItems().indexOf(cellData.getValue()) + 1)));</span>
<span class="nc" id="L148">        new ValueTableCellFactory&lt;BibEntryTableViewModel, String&gt;()</span>
<span class="nc" id="L149">                .withText(text -&gt; text)</span>
<span class="nc" id="L150">                .install(column);</span>
<span class="nc" id="L151">        column.setSortable(false);</span>
<span class="nc" id="L152">        return column;</span>
    }

    /**
     * Creates a column for group color bars.
     */
    private TableColumn&lt;BibEntryTableViewModel, ?&gt; createGroupColumn(MainTableColumnModel columnModel) {
<span class="nc" id="L159">        TableColumn&lt;BibEntryTableViewModel, List&lt;AbstractGroup&gt;&gt; column = new MainTableColumn&lt;&gt;(columnModel);</span>
<span class="nc" id="L160">        Node headerGraphic = IconTheme.JabRefIcons.DEFAULT_GROUP_ICON.getGraphicNode();</span>
<span class="nc" id="L161">        Tooltip.install(headerGraphic, new Tooltip(Localization.lang(&quot;Group color&quot;)));</span>
<span class="nc" id="L162">        column.setGraphic(headerGraphic);</span>
<span class="nc" id="L163">        column.getStyleClass().add(STYLE_ICON_COLUMN);</span>
<span class="nc" id="L164">        setExactWidth(column, ColumnPreferences.ICON_COLUMN_WIDTH);</span>
<span class="nc" id="L165">        column.setResizable(false);</span>
<span class="nc" id="L166">        column.setCellValueFactory(cellData -&gt; cellData.getValue().getMatchedGroups());</span>
<span class="nc" id="L167">        new ValueTableCellFactory&lt;BibEntryTableViewModel, List&lt;AbstractGroup&gt;&gt;()</span>
<span class="nc" id="L168">                .withGraphic(this::createGroupColorRegion)</span>
<span class="nc" id="L169">                .install(column);</span>
<span class="nc" id="L170">        column.setStyle(&quot;-fx-padding: 0 0 0 0;&quot;);</span>
<span class="nc" id="L171">        column.setSortable(true);</span>
<span class="nc" id="L172">        return column;</span>
    }

    private Node createGroupColorRegion(BibEntryTableViewModel entry, List&lt;AbstractGroup&gt; matchedGroups) {
<span class="nc" id="L176">        List&lt;Color&gt; groupColors = matchedGroups.stream()</span>
<span class="nc" id="L177">                                               .flatMap(group -&gt; OptionalUtil.toStream(group.getColor()))</span>
<span class="nc" id="L178">                                               .collect(Collectors.toList());</span>

<span class="nc bnc" id="L180" title="All 2 branches missed.">        if (!groupColors.isEmpty()) {</span>
<span class="nc" id="L181">            HBox container = new HBox();</span>
<span class="nc" id="L182">            container.setSpacing(2);</span>
<span class="nc" id="L183">            container.setMinWidth(10);</span>
<span class="nc" id="L184">            container.setAlignment(Pos.CENTER_LEFT);</span>
<span class="nc" id="L185">            container.setPadding(new Insets(0, 2, 0, 2));</span>

<span class="nc" id="L187">            groupColors.stream().distinct().forEach(groupColor -&gt; {</span>
<span class="nc" id="L188">                Rectangle groupRectangle = new Rectangle();</span>
<span class="nc" id="L189">                groupRectangle.getStyleClass().add(&quot;groupColumnBackground&quot;);</span>
<span class="nc" id="L190">                groupRectangle.setWidth(3);</span>
<span class="nc" id="L191">                groupRectangle.setHeight(18);</span>
<span class="nc" id="L192">                groupRectangle.setFill(groupColor);</span>
<span class="nc" id="L193">                groupRectangle.setStrokeWidth(1);</span>
<span class="nc" id="L194">                container.getChildren().add(groupRectangle);</span>
<span class="nc" id="L195">            });</span>

<span class="nc" id="L197">            String matchedGroupsString = matchedGroups.stream()</span>
<span class="nc" id="L198">                                                      .distinct()</span>
<span class="nc" id="L199">                                                      .map(AbstractGroup::getName)</span>
<span class="nc" id="L200">                                                      .collect(Collectors.joining(&quot;, &quot;));</span>
<span class="nc" id="L201">            Tooltip tooltip = new Tooltip(Localization.lang(&quot;Entry is contained in the following groups:&quot;) + &quot;\n&quot; + matchedGroupsString);</span>
<span class="nc" id="L202">            Tooltip.install(container, tooltip);</span>
<span class="nc" id="L203">            return container;</span>
        }
<span class="nc" id="L205">        return new Pane();</span>
    }

    /**
     * Creates a text column to display any standard field.
     */
    private TableColumn&lt;BibEntryTableViewModel, ?&gt; createFieldColumn(MainTableColumnModel columnModel) {
<span class="nc" id="L212">        return new FieldColumn(columnModel);</span>
    }

    /**
     * Creates a clickable icons column for DOIs, URLs, URIs and EPrints.
     */
    private TableColumn&lt;BibEntryTableViewModel, Map&lt;Field, String&gt;&gt; createIdentifierColumn(MainTableColumnModel columnModel) {
<span class="nc" id="L219">        return new LinkedIdentifierColumn(columnModel, cellFactory, database, dialogService, preferencesService, stateManager);</span>
    }

    /**
     * Creates a column that displays a {@link SpecialField}
     */
    private TableColumn&lt;BibEntryTableViewModel, Optional&lt;SpecialFieldValueViewModel&gt;&gt; createSpecialFieldColumn(MainTableColumnModel columnModel) {
<span class="nc" id="L226">        return new SpecialFieldColumn(columnModel, preferencesService, undoManager);</span>
    }

    /**
     * Creates a column for all the linked files. Instead of creating a column for a single file type, like {@link
     * #createExtraFileColumn(MainTableColumnModel)} createExtraFileColumn} does, this creates one single column collecting all file links.
     */
    private TableColumn&lt;BibEntryTableViewModel, List&lt;LinkedFile&gt;&gt; createFilesColumn(MainTableColumnModel columnModel) {
<span class="nc" id="L234">        return new FileColumn(columnModel,</span>
                database,
                externalFileTypes,
                dialogService,
                preferencesService);
    }

    /**
     * Creates a column for all the linked files of a single file type.
     */
    private TableColumn&lt;BibEntryTableViewModel, List&lt;LinkedFile&gt;&gt; createExtraFileColumn(MainTableColumnModel columnModel) {
<span class="nc" id="L245">        return new FileColumn(columnModel,</span>
                database,
                externalFileTypes,
                dialogService,
                preferencesService,
<span class="nc" id="L250">                columnModel.getQualifier());</span>
    }

    /**
     * Create library column containing the Filename of the library's bib file
     */
    private TableColumn&lt;BibEntryTableViewModel, String&gt; createLibraryColumn(MainTableColumnModel columnModel) {
<span class="nc" id="L257">        return new LibraryColumn(columnModel);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>