<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ModsExporter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JabRef</a> &gt; <a href="index.source.html" class="el_package">org.jabref.logic.exporter</a> &gt; <span class="el_source">ModsExporter.java</span></div><h1>ModsExporter.java</h1><pre class="source lang-java linenums">package org.jabref.logic.exporter;

import java.math.BigInteger;
import java.nio.charset.Charset;
import java.nio.file.Path;
import java.util.Comparator;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.TreeMap;

import javax.xml.namespace.QName;

import org.jabref.logic.importer.fileformat.mods.AbstractDefinition;
import org.jabref.logic.importer.fileformat.mods.CodeOrText;
import org.jabref.logic.importer.fileformat.mods.DateDefinition;
import org.jabref.logic.importer.fileformat.mods.DetailDefinition;
import org.jabref.logic.importer.fileformat.mods.ExtentDefinition;
import org.jabref.logic.importer.fileformat.mods.GenreDefinition;
import org.jabref.logic.importer.fileformat.mods.IdentifierDefinition;
import org.jabref.logic.importer.fileformat.mods.IssuanceDefinition;
import org.jabref.logic.importer.fileformat.mods.LanguageDefinition;
import org.jabref.logic.importer.fileformat.mods.LanguageTermDefinition;
import org.jabref.logic.importer.fileformat.mods.LocationDefinition;
import org.jabref.logic.importer.fileformat.mods.ModsCollectionDefinition;
import org.jabref.logic.importer.fileformat.mods.ModsDefinition;
import org.jabref.logic.importer.fileformat.mods.NameDefinition;
import org.jabref.logic.importer.fileformat.mods.NamePartDefinition;
import org.jabref.logic.importer.fileformat.mods.NoteDefinition;
import org.jabref.logic.importer.fileformat.mods.OriginInfoDefinition;
import org.jabref.logic.importer.fileformat.mods.PartDefinition;
import org.jabref.logic.importer.fileformat.mods.PhysicalLocationDefinition;
import org.jabref.logic.importer.fileformat.mods.PlaceDefinition;
import org.jabref.logic.importer.fileformat.mods.PlaceTermDefinition;
import org.jabref.logic.importer.fileformat.mods.RelatedItemDefinition;
import org.jabref.logic.importer.fileformat.mods.StringPlusLanguage;
import org.jabref.logic.importer.fileformat.mods.StringPlusLanguagePlusAuthority;
import org.jabref.logic.importer.fileformat.mods.StringPlusLanguagePlusSupplied;
import org.jabref.logic.importer.fileformat.mods.SubjectDefinition;
import org.jabref.logic.importer.fileformat.mods.TitleInfoDefinition;
import org.jabref.logic.importer.fileformat.mods.TypeOfResourceDefinition;
import org.jabref.logic.importer.fileformat.mods.UrlDefinition;
import org.jabref.logic.util.StandardFileType;
import org.jabref.model.database.BibDatabaseContext;
import org.jabref.model.entry.BibEntry;
import org.jabref.model.entry.field.Field;
import org.jabref.model.entry.field.StandardField;
import org.jabref.model.entry.field.UnknownField;
import org.jabref.model.entry.types.EntryType;

import jakarta.xml.bind.JAXBContext;
import jakarta.xml.bind.JAXBElement;
import jakarta.xml.bind.JAXBException;
import jakarta.xml.bind.Marshaller;

/**
 * TemplateExporter for exporting in MODS XML format.
 */
class ModsExporter extends Exporter {

    private static final String MODS_NAMESPACE_URI = &quot;http://www.loc.gov/mods/v3&quot;;
    private static final String MINUS = &quot;-&quot;;
    private static final String DOUBLE_MINUS = &quot;--&quot;;
    private static final String MODS_SCHEMA_LOCATION = &quot;http://www.loc.gov/standards/mods/v3/mods-3-6.xsd&quot;;
    private JAXBContext context;

    public ModsExporter() {
<span class="fc" id="L68">        super(&quot;mods&quot;, &quot;MODS&quot;, StandardFileType.XML);</span>
<span class="fc" id="L69">    }</span>

    @Override
    public void export(final BibDatabaseContext databaseContext, final Path file, final Charset encoding, List&lt;BibEntry&gt; entries) throws SaveException {
<span class="fc" id="L73">        Objects.requireNonNull(databaseContext);</span>
<span class="fc" id="L74">        Objects.requireNonNull(entries);</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (entries.isEmpty()) { // Only export if entries exist</span>
<span class="fc" id="L76">            return;</span>
        }

        try {
<span class="fc" id="L80">            ModsCollectionDefinition modsCollection = new ModsCollectionDefinition();</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">            for (BibEntry bibEntry : entries) {</span>
<span class="fc" id="L82">                ModsDefinition mods = new ModsDefinition();</span>
<span class="fc" id="L83">                bibEntry.getCitationKey().ifPresent(citeKey -&gt; addIdentifier(new UnknownField(&quot;citekey&quot;), citeKey, mods));</span>

<span class="fc" id="L85">                Map&lt;Field, String&gt; fieldMap = new TreeMap&lt;&gt;(Comparator.comparing(Field::getName));</span>
<span class="fc" id="L86">                fieldMap.putAll(bibEntry.getFieldMap());</span>
<span class="fc" id="L87">                addGenre(mods, bibEntry.getType());</span>

<span class="fc" id="L89">                OriginInfoDefinition originInfo = new OriginInfoDefinition();</span>
<span class="fc" id="L90">                PartDefinition partDefinition = new PartDefinition();</span>
<span class="fc" id="L91">                RelatedItemDefinition relatedItem = new RelatedItemDefinition();</span>

<span class="fc bfc" id="L93" title="All 2 branches covered.">                for (Map.Entry&lt;Field, String&gt; entry : fieldMap.entrySet()) {</span>
<span class="fc" id="L94">                    Field field = entry.getKey();</span>
<span class="fc" id="L95">                    String value = entry.getValue();</span>

<span class="fc bfc" id="L97" title="All 2 branches covered.">                    if (StandardField.AUTHOR.equals(field)) {</span>
<span class="fc" id="L98">                        handleAuthors(mods, value);</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">                    } else if (new UnknownField(&quot;affiliation&quot;).equals(field)) {</span>
<span class="fc" id="L100">                        addAffiliation(mods, value);</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">                    } else if (StandardField.ABSTRACT.equals(field)) {</span>
<span class="fc" id="L102">                        addAbstract(mods, value);</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">                    } else if (StandardField.TITLE.equals(field)) {</span>
<span class="fc" id="L104">                        addTitle(mods, value);</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">                    } else if (StandardField.LANGUAGE.equals(field)) {</span>
<span class="fc" id="L106">                        addLanguage(mods, value);</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">                    } else if (StandardField.LOCATION.equals(field)) {</span>
<span class="fc" id="L108">                        addLocation(mods, value);</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">                    } else if (StandardField.URL.equals(field)) {</span>
<span class="fc" id="L110">                        addUrl(mods, value);</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">                    } else if (StandardField.NOTE.equals(field)) {</span>
<span class="fc" id="L112">                        addNote(mods, value);</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">                    } else if (StandardField.KEYWORDS.equals(field)) {</span>
<span class="fc" id="L114">                        addKeyWords(mods, value);</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">                    } else if (StandardField.VOLUME.equals(field)) {</span>
<span class="fc" id="L116">                        addDetail(StandardField.VOLUME, value, partDefinition);</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">                    } else if (StandardField.ISSUE.equals(field)) {</span>
<span class="fc" id="L118">                        addDetail(StandardField.ISSUE, value, partDefinition);</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">                    } else if (StandardField.PAGES.equals(field)) {</span>
<span class="fc" id="L120">                        addPages(partDefinition, value);</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">                    } else if (StandardField.URI.equals(field)) {</span>
<span class="fc" id="L122">                        addIdentifier(StandardField.URI, value, mods);</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">                    } else if (StandardField.ISBN.equals(field)) {</span>
<span class="fc" id="L124">                        addIdentifier(StandardField.ISBN, value, mods);</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">                    } else if (StandardField.ISSN.equals(field)) {</span>
<span class="fc" id="L126">                        addIdentifier(StandardField.ISSN, value, mods);</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">                    } else if (StandardField.DOI.equals(field)) {</span>
<span class="fc" id="L128">                        addIdentifier(StandardField.DOI, value, mods);</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">                    } else if (StandardField.PMID.equals(field)) {</span>
<span class="fc" id="L130">                        addIdentifier(StandardField.PMID, value, mods);</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">                    } else if (StandardField.JOURNAL.equals(field)) {</span>
<span class="fc" id="L132">                        addJournal(value, relatedItem);</span>
                    }

<span class="fc" id="L135">                    addOriginInformation(field, value, originInfo);</span>
<span class="fc" id="L136">                }</span>
<span class="fc" id="L137">                mods.getModsGroup().add(originInfo);</span>

<span class="fc" id="L139">                addRelatedAndOriginInfoToModsGroup(relatedItem, partDefinition, mods);</span>
<span class="fc" id="L140">                modsCollection.getMods().add(mods);</span>
<span class="fc" id="L141">            }</span>

<span class="fc" id="L143">            JAXBElement&lt;ModsCollectionDefinition&gt; jaxbElement = new JAXBElement&lt;&gt;(</span>
                    new QName(MODS_NAMESPACE_URI, &quot;modsCollection&quot;), ModsCollectionDefinition.class, modsCollection);

<span class="fc" id="L146">            createMarshallerAndWriteToFile(file, jaxbElement);</span>
<span class="nc" id="L147">        } catch (JAXBException ex) {</span>
<span class="nc" id="L148">            throw new SaveException(ex);</span>
<span class="fc" id="L149">        }</span>
<span class="fc" id="L150">    }</span>

    private void createMarshallerAndWriteToFile(Path file, JAXBElement&lt;ModsCollectionDefinition&gt; jaxbElement)
            throws JAXBException {

<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        if (context == null) {</span>
<span class="fc" id="L156">            context = JAXBContext.newInstance(ModsCollectionDefinition.class);</span>
        }
<span class="fc" id="L158">        Marshaller marshaller = context.createMarshaller();</span>
        // format the output
<span class="fc" id="L160">        marshaller.setProperty(Marshaller.JAXB_FORMATTED_OUTPUT, Boolean.TRUE);</span>
<span class="fc" id="L161">        marshaller.setProperty(Marshaller.JAXB_SCHEMA_LOCATION, MODS_SCHEMA_LOCATION);</span>

        // Write to File
<span class="fc" id="L164">        marshaller.marshal(jaxbElement, file.toFile());</span>
<span class="fc" id="L165">    }</span>

    private void addRelatedAndOriginInfoToModsGroup(RelatedItemDefinition relatedItem, PartDefinition partDefinition,
                                                    ModsDefinition mods) {

<span class="fc" id="L170">        relatedItem.getModsGroup().add(partDefinition);</span>
<span class="fc" id="L171">        relatedItem.setAtType(&quot;host&quot;);</span>
<span class="fc" id="L172">        mods.getModsGroup().add(relatedItem);</span>
<span class="fc" id="L173">        TypeOfResourceDefinition typeOfResource = new TypeOfResourceDefinition();</span>
<span class="fc" id="L174">        typeOfResource.setValue(&quot;text&quot;);</span>
<span class="fc" id="L175">        mods.getModsGroup().add(typeOfResource);</span>
<span class="fc" id="L176">    }</span>

    private void addGenre(ModsDefinition mods, EntryType entryType) {
<span class="fc" id="L179">        GenreDefinition genre = new GenreDefinition();</span>
<span class="fc" id="L180">        genre.setValue(entryType.getName());</span>
<span class="fc" id="L181">        mods.getModsGroup().add(genre);</span>
<span class="fc" id="L182">    }</span>

    private void addAbstract(ModsDefinition mods, String value) {
<span class="fc" id="L185">        AbstractDefinition abstractDefinition = new AbstractDefinition();</span>
<span class="fc" id="L186">        abstractDefinition.setValue(value);</span>
<span class="fc" id="L187">        mods.getModsGroup().add(abstractDefinition);</span>
<span class="fc" id="L188">    }</span>

    private void addTitle(ModsDefinition mods, String value) {
<span class="fc" id="L191">        TitleInfoDefinition titleInfo = new TitleInfoDefinition();</span>
<span class="fc" id="L192">        StringPlusLanguage title = new StringPlusLanguage();</span>
<span class="fc" id="L193">        title.setValue(value);</span>
<span class="fc" id="L194">        JAXBElement&lt;StringPlusLanguage&gt; element = new JAXBElement&lt;&gt;(new QName(MODS_NAMESPACE_URI, &quot;title&quot;),</span>
                StringPlusLanguage.class, title);
<span class="fc" id="L196">        titleInfo.getTitleOrSubTitleOrPartNumber().add(element);</span>
<span class="fc" id="L197">        mods.getModsGroup().add(titleInfo);</span>
<span class="fc" id="L198">    }</span>

    private void addAffiliation(ModsDefinition mods, String value) {
<span class="fc" id="L201">        NameDefinition nameDefinition = new NameDefinition();</span>
<span class="fc" id="L202">        StringPlusLanguage affiliation = new StringPlusLanguage();</span>
<span class="fc" id="L203">        affiliation.setValue(value);</span>
<span class="fc" id="L204">        JAXBElement&lt;StringPlusLanguage&gt; element = new JAXBElement&lt;&gt;(new QName(MODS_NAMESPACE_URI, &quot;affiliation&quot;),</span>
                StringPlusLanguage.class, affiliation);
<span class="fc" id="L206">        nameDefinition.getAffiliationOrRoleOrDescription().add(element);</span>
<span class="fc" id="L207">        mods.getModsGroup().add(nameDefinition);</span>
<span class="fc" id="L208">    }</span>

    private void addLocation(ModsDefinition mods, String value) {
<span class="fc" id="L211">        LocationDefinition locationDefinition = new LocationDefinition();</span>
        // There can be more than one location
<span class="fc" id="L213">        String[] locations = value.split(&quot;, &quot;);</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">        for (String location : locations) {</span>
<span class="fc" id="L215">            PhysicalLocationDefinition physicalLocation = new PhysicalLocationDefinition();</span>
<span class="fc" id="L216">            physicalLocation.setValue(location);</span>
<span class="fc" id="L217">            locationDefinition.getPhysicalLocation().add(physicalLocation);</span>
        }
<span class="fc" id="L219">        mods.getModsGroup().add(locationDefinition);</span>
<span class="fc" id="L220">    }</span>

    private void addNote(ModsDefinition mods, String value) {
<span class="fc" id="L223">        String[] notes = value.split(&quot;, &quot;);</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">        for (String note : notes) {</span>
<span class="fc" id="L225">            NoteDefinition noteDefinition = new NoteDefinition();</span>
<span class="fc" id="L226">            noteDefinition.setValue(note);</span>
<span class="fc" id="L227">            mods.getModsGroup().add(noteDefinition);</span>
        }
<span class="fc" id="L229">    }</span>

    private void addUrl(ModsDefinition mods, String value) {
<span class="fc" id="L232">        String[] urls = value.split(&quot;, &quot;);</span>
<span class="fc" id="L233">        LocationDefinition location = new LocationDefinition();</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">        for (String url : urls) {</span>
<span class="fc" id="L235">            UrlDefinition urlDefinition = new UrlDefinition();</span>
<span class="fc" id="L236">            urlDefinition.setValue(url);</span>
<span class="fc" id="L237">            location.getUrl().add(urlDefinition);</span>
<span class="fc" id="L238">            mods.getModsGroup().add(location);</span>
        }
<span class="fc" id="L240">    }</span>

    private void addJournal(String value, RelatedItemDefinition relatedItem) {
<span class="fc" id="L243">        TitleInfoDefinition titleInfo = new TitleInfoDefinition();</span>
<span class="fc" id="L244">        StringPlusLanguage title = new StringPlusLanguage();</span>
<span class="fc" id="L245">        title.setValue(value);</span>
<span class="fc" id="L246">        JAXBElement&lt;StringPlusLanguage&gt; element = new JAXBElement&lt;&gt;(new QName(MODS_NAMESPACE_URI, &quot;title&quot;),</span>
                StringPlusLanguage.class, title);
<span class="fc" id="L248">        titleInfo.getTitleOrSubTitleOrPartNumber().add(element);</span>
<span class="fc" id="L249">        relatedItem.getModsGroup().add(titleInfo);</span>
<span class="fc" id="L250">    }</span>

    private void addLanguage(ModsDefinition mods, String value) {
<span class="fc" id="L253">        LanguageDefinition language = new LanguageDefinition();</span>
<span class="fc" id="L254">        LanguageTermDefinition languageTerm = new LanguageTermDefinition();</span>
<span class="fc" id="L255">        languageTerm.setValue(value);</span>
<span class="fc" id="L256">        language.getLanguageTerm().add(languageTerm);</span>
<span class="fc" id="L257">        mods.getModsGroup().add(language);</span>
<span class="fc" id="L258">    }</span>

    private void addPages(PartDefinition partDefinition, String value) {
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">        if (value.contains(DOUBLE_MINUS)) {</span>
<span class="nc" id="L262">            addStartAndEndPage(value, partDefinition, DOUBLE_MINUS);</span>
<span class="fc bfc" id="L263" title="All 2 branches covered.">        } else if (value.contains(MINUS)) {</span>
<span class="fc" id="L264">            addStartAndEndPage(value, partDefinition, MINUS);</span>
        } else {
<span class="fc" id="L266">            BigInteger total = new BigInteger(value);</span>
<span class="fc" id="L267">            ExtentDefinition extent = new ExtentDefinition();</span>
<span class="fc" id="L268">            extent.setTotal(total);</span>
<span class="fc" id="L269">            partDefinition.getDetailOrExtentOrDate().add(extent);</span>
        }
<span class="fc" id="L271">    }</span>

    private void addKeyWords(ModsDefinition mods, String value) {
<span class="fc" id="L274">        String[] keywords = value.split(&quot;, &quot;);</span>

<span class="fc bfc" id="L276" title="All 2 branches covered.">        for (String keyword : keywords) {</span>
<span class="fc" id="L277">            SubjectDefinition subject = new SubjectDefinition();</span>
<span class="fc" id="L278">            StringPlusLanguagePlusAuthority topic = new StringPlusLanguagePlusAuthority();</span>
<span class="fc" id="L279">            topic.setValue(keyword);</span>
<span class="fc" id="L280">            JAXBElement&lt;?&gt; element = new JAXBElement&lt;&gt;(new QName(MODS_NAMESPACE_URI, &quot;topic&quot;),</span>
                    StringPlusLanguagePlusAuthority.class, topic);
<span class="fc" id="L282">            subject.getTopicOrGeographicOrTemporal().add(element);</span>
<span class="fc" id="L283">            mods.getModsGroup().add(subject);</span>
        }
<span class="fc" id="L285">    }</span>

    private void handleAuthors(ModsDefinition mods, String value) {
<span class="fc" id="L288">        String[] authors = value.split(&quot;and&quot;);</span>
<span class="fc bfc" id="L289" title="All 2 branches covered.">        for (String author : authors) {</span>
<span class="fc" id="L290">            NameDefinition name = new NameDefinition();</span>
<span class="fc" id="L291">            name.setAtType(&quot;personal&quot;);</span>
<span class="fc" id="L292">            NamePartDefinition namePart = new NamePartDefinition();</span>
<span class="fc bfc" id="L293" title="All 2 branches covered.">            if (author.contains(&quot;,&quot;)) {</span>
                // if author contains &quot;,&quot;  then this indicates that the author has a forename and family name
<span class="fc" id="L295">                int commaIndex = author.indexOf(',');</span>
<span class="fc" id="L296">                String familyName = author.substring(0, commaIndex);</span>
<span class="fc" id="L297">                namePart.setAtType(&quot;family&quot;);</span>
<span class="fc" id="L298">                namePart.setValue(familyName);</span>

<span class="fc" id="L300">                JAXBElement&lt;NamePartDefinition&gt; element = new JAXBElement&lt;&gt;(new QName(MODS_NAMESPACE_URI, &quot;namePart&quot;),</span>
                        NamePartDefinition.class, namePart);
<span class="fc" id="L302">                name.getNamePartOrDisplayFormOrAffiliation().add(element);</span>

                // now take care of the forenames
<span class="fc" id="L305">                String forename = author.substring(commaIndex + 1);</span>
<span class="fc" id="L306">                String[] forenames = forename.split(&quot; &quot;);</span>
<span class="fc bfc" id="L307" title="All 2 branches covered.">                for (String given : forenames) {</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">                    if (!given.isEmpty()) {</span>
<span class="fc" id="L309">                        NamePartDefinition namePartDefinition = new NamePartDefinition();</span>
<span class="fc" id="L310">                        namePartDefinition.setAtType(&quot;given&quot;);</span>
<span class="fc" id="L311">                        namePartDefinition.setValue(given);</span>
<span class="fc" id="L312">                        element = new JAXBElement&lt;&gt;(new QName(MODS_NAMESPACE_URI, &quot;namePart&quot;), NamePartDefinition.class,</span>
                                namePartDefinition);
<span class="fc" id="L314">                        name.getNamePartOrDisplayFormOrAffiliation().add(element);</span>
                    }
                }
<span class="fc" id="L317">                mods.getModsGroup().add(name);</span>
<span class="fc" id="L318">            } else {</span>
                // no &quot;,&quot; indicates that there should only be a family name
<span class="fc" id="L320">                namePart.setAtType(&quot;family&quot;);</span>
<span class="fc" id="L321">                namePart.setValue(author);</span>
<span class="fc" id="L322">                JAXBElement&lt;NamePartDefinition&gt; element = new JAXBElement&lt;&gt;(new QName(MODS_NAMESPACE_URI, &quot;namePart&quot;),</span>
                        NamePartDefinition.class, namePart);
<span class="fc" id="L324">                name.getNamePartOrDisplayFormOrAffiliation().add(element);</span>
<span class="fc" id="L325">                mods.getModsGroup().add(name);</span>
            }
        }
<span class="fc" id="L328">    }</span>

    private void addIdentifier(Field field, String value, ModsDefinition mods) {
<span class="fc bfc" id="L331" title="All 2 branches covered.">        if (new UnknownField(&quot;citekey&quot;).equals(field)) {</span>
<span class="fc" id="L332">            mods.setID(value);</span>
        }
<span class="fc" id="L334">        IdentifierDefinition identifier = new IdentifierDefinition();</span>
<span class="fc" id="L335">        identifier.setType(field.getName());</span>
<span class="fc" id="L336">        identifier.setValue(value);</span>
<span class="fc" id="L337">        mods.getModsGroup().add(identifier);</span>
<span class="fc" id="L338">    }</span>

    private void addStartAndEndPage(String value, PartDefinition partDefinition, String minus) {
<span class="fc" id="L341">        int minusIndex = value.indexOf(minus);</span>
<span class="fc" id="L342">        String startPage = value.substring(0, minusIndex);</span>
<span class="fc" id="L343">        String endPage = &quot;&quot;;</span>
<span class="pc bpc" id="L344" title="1 of 2 branches missed.">        if (MINUS.equals(minus)) {</span>
<span class="fc" id="L345">            endPage = value.substring(minusIndex + 1);</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">        } else if (DOUBLE_MINUS.equals(minus)) {</span>
<span class="nc" id="L347">            endPage = value.substring(minusIndex + 2);</span>
        }

<span class="fc" id="L350">        StringPlusLanguage start = new StringPlusLanguage();</span>
<span class="fc" id="L351">        start.setValue(startPage);</span>
<span class="fc" id="L352">        StringPlusLanguage end = new StringPlusLanguage();</span>
<span class="fc" id="L353">        end.setValue(endPage);</span>
<span class="fc" id="L354">        ExtentDefinition extent = new ExtentDefinition();</span>
<span class="fc" id="L355">        extent.setStart(start);</span>
<span class="fc" id="L356">        extent.setEnd(end);</span>

<span class="fc" id="L358">        partDefinition.getDetailOrExtentOrDate().add(extent);</span>
<span class="fc" id="L359">    }</span>

    private void addDetail(Field field, String value, PartDefinition partDefinition) {
<span class="fc" id="L362">        DetailDefinition detail = new DetailDefinition();</span>
<span class="fc" id="L363">        StringPlusLanguage detailType = new StringPlusLanguage();</span>
<span class="fc" id="L364">        detailType.setValue(value);</span>
<span class="fc" id="L365">        detail.setType(field.getName());</span>
<span class="fc" id="L366">        JAXBElement&lt;StringPlusLanguage&gt; element = new JAXBElement&lt;&gt;(new QName(MODS_NAMESPACE_URI, &quot;number&quot;),</span>
                StringPlusLanguage.class, detailType);
<span class="fc" id="L368">        detail.getNumberOrCaptionOrTitle().add(element);</span>
<span class="fc" id="L369">        partDefinition.getDetailOrExtentOrDate().add(detail);</span>
<span class="fc" id="L370">    }</span>

    private void addOriginInformation(Field field, String value, OriginInfoDefinition originInfo) {
<span class="fc bfc" id="L373" title="All 2 branches covered.">        if (field.equals(StandardField.YEAR)) {</span>
<span class="fc" id="L374">            addDate(&quot;dateIssued&quot;, value, originInfo);</span>
<span class="fc bfc" id="L375" title="All 2 branches covered.">        } else if (field.equals(new UnknownField(&quot;created&quot;))) {</span>
<span class="fc" id="L376">            addDate(&quot;dateCreated&quot;, value, originInfo);</span>
<span class="fc bfc" id="L377" title="All 2 branches covered.">        } else if (field.equals(new UnknownField(&quot;modified&quot;))) {</span>
<span class="fc" id="L378">            addDate(&quot;dateModified&quot;, value, originInfo);</span>
<span class="fc bfc" id="L379" title="All 2 branches covered.">        } else if (field.equals(new UnknownField(&quot;captured&quot;))) {</span>
<span class="fc" id="L380">            addDate(&quot;dateCaptured&quot;, value, originInfo);</span>
<span class="fc bfc" id="L381" title="All 2 branches covered.">        } else if (StandardField.PUBLISHER.equals(field)) {</span>
<span class="fc" id="L382">            StringPlusLanguagePlusSupplied publisher = new StringPlusLanguagePlusSupplied();</span>
<span class="fc" id="L383">            publisher.setValue(value);</span>
<span class="fc" id="L384">            JAXBElement&lt;StringPlusLanguagePlusSupplied&gt; element = new JAXBElement&lt;&gt;(</span>
                    new QName(MODS_NAMESPACE_URI, &quot;publisher&quot;), StringPlusLanguagePlusSupplied.class, publisher);
<span class="fc" id="L386">            originInfo.getPlaceOrPublisherOrDateIssued().add(element);</span>
<span class="fc bfc" id="L387" title="All 2 branches covered.">        } else if (field.equals(new UnknownField(&quot;issuance&quot;))) {</span>
<span class="fc" id="L388">            IssuanceDefinition issuance = IssuanceDefinition.fromValue(value);</span>
<span class="fc" id="L389">            JAXBElement&lt;IssuanceDefinition&gt; element = new JAXBElement&lt;&gt;(new QName(MODS_NAMESPACE_URI, &quot;issuance&quot;),</span>
                    IssuanceDefinition.class, issuance);
<span class="fc" id="L391">            originInfo.getPlaceOrPublisherOrDateIssued().add(element);</span>
<span class="fc bfc" id="L392" title="All 2 branches covered.">        } else if (field.equals(StandardField.ADDRESS)) {</span>
<span class="fc" id="L393">            PlaceDefinition placeDefinition = new PlaceDefinition();</span>
            // There can be more than one place, so we split to get all places and add them
<span class="fc" id="L395">            String[] places = value.split(&quot;, &quot;);</span>
<span class="fc bfc" id="L396" title="All 2 branches covered.">            for (String place : places) {</span>
<span class="fc" id="L397">                PlaceTermDefinition placeTerm = new PlaceTermDefinition();</span>
                // There's no possibility to see from a bib entry whether it is code or text, but since it is in the bib entry
                // we assume that it is text
<span class="fc" id="L400">                placeTerm.setType(CodeOrText.TEXT);</span>
<span class="fc" id="L401">                placeTerm.setValue(place);</span>
<span class="fc" id="L402">                placeDefinition.getPlaceTerm().add(placeTerm);</span>
            }
<span class="fc" id="L404">            JAXBElement&lt;PlaceDefinition&gt; element = new JAXBElement&lt;&gt;(new QName(MODS_NAMESPACE_URI, &quot;place&quot;),</span>
                    PlaceDefinition.class, placeDefinition);
<span class="fc" id="L406">            originInfo.getPlaceOrPublisherOrDateIssued().add(element);</span>
<span class="fc bfc" id="L407" title="All 2 branches covered.">        } else if (field.equals(StandardField.EDITION)) {</span>
<span class="fc" id="L408">            StringPlusLanguagePlusSupplied edition = new StringPlusLanguagePlusSupplied();</span>
<span class="fc" id="L409">            edition.setValue(value);</span>
<span class="fc" id="L410">            JAXBElement&lt;StringPlusLanguagePlusSupplied&gt; element = new JAXBElement&lt;&gt;(</span>
                    new QName(MODS_NAMESPACE_URI, &quot;edition&quot;), StringPlusLanguagePlusSupplied.class, edition);
<span class="fc" id="L412">            originInfo.getPlaceOrPublisherOrDateIssued().add(element);</span>
        }
<span class="fc" id="L414">    }</span>

    private void addDate(String dateName, String value, OriginInfoDefinition originInfo) {
<span class="fc" id="L417">        DateDefinition dateIssued = new DateDefinition();</span>
<span class="fc" id="L418">        dateIssued.setKeyDate(&quot;yes&quot;);</span>
<span class="fc" id="L419">        dateIssued.setValue(value);</span>
<span class="fc" id="L420">        JAXBElement&lt;DateDefinition&gt; element = new JAXBElement&lt;&gt;(new QName(MODS_NAMESPACE_URI, dateName),</span>
                DateDefinition.class, dateIssued);
<span class="fc" id="L422">        originInfo.getPlaceOrPublisherOrDateIssued().add(element);</span>
<span class="fc" id="L423">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>