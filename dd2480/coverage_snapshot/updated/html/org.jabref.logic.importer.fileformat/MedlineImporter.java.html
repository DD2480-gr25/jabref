<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MedlineImporter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JabRef</a> &gt; <a href="index.source.html" class="el_package">org.jabref.logic.importer.fileformat</a> &gt; <span class="el_source">MedlineImporter.java</span></div><h1>MedlineImporter.java</h1><pre class="source lang-java linenums">package org.jabref.logic.importer.fileformat;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.Serializable;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;

import javax.xml.stream.XMLInputFactory;
import javax.xml.stream.XMLStreamException;
import javax.xml.stream.XMLStreamReader;

import org.jabref.logic.importer.Importer;
import org.jabref.logic.importer.ParseException;
import org.jabref.logic.importer.Parser;
import org.jabref.logic.importer.ParserResult;
import org.jabref.logic.importer.fileformat.medline.Abstract;
import org.jabref.logic.importer.fileformat.medline.AbstractText;
import org.jabref.logic.importer.fileformat.medline.AffiliationInfo;
import org.jabref.logic.importer.fileformat.medline.ArticleId;
import org.jabref.logic.importer.fileformat.medline.ArticleIdList;
import org.jabref.logic.importer.fileformat.medline.ArticleTitle;
import org.jabref.logic.importer.fileformat.medline.Author;
import org.jabref.logic.importer.fileformat.medline.AuthorList;
import org.jabref.logic.importer.fileformat.medline.Book;
import org.jabref.logic.importer.fileformat.medline.BookDocument;
import org.jabref.logic.importer.fileformat.medline.BookTitle;
import org.jabref.logic.importer.fileformat.medline.Chemical;
import org.jabref.logic.importer.fileformat.medline.ContributionDate;
import org.jabref.logic.importer.fileformat.medline.DateCompleted;
import org.jabref.logic.importer.fileformat.medline.DateCreated;
import org.jabref.logic.importer.fileformat.medline.DateRevised;
import org.jabref.logic.importer.fileformat.medline.ELocationID;
import org.jabref.logic.importer.fileformat.medline.GeneSymbolList;
import org.jabref.logic.importer.fileformat.medline.GeneralNote;
import org.jabref.logic.importer.fileformat.medline.ISSN;
import org.jabref.logic.importer.fileformat.medline.Investigator;
import org.jabref.logic.importer.fileformat.medline.InvestigatorList;
import org.jabref.logic.importer.fileformat.medline.Journal;
import org.jabref.logic.importer.fileformat.medline.JournalIssue;
import org.jabref.logic.importer.fileformat.medline.Keyword;
import org.jabref.logic.importer.fileformat.medline.KeywordList;
import org.jabref.logic.importer.fileformat.medline.MedlineCitation;
import org.jabref.logic.importer.fileformat.medline.MedlineJournalInfo;
import org.jabref.logic.importer.fileformat.medline.MeshHeading;
import org.jabref.logic.importer.fileformat.medline.MeshHeadingList;
import org.jabref.logic.importer.fileformat.medline.OtherID;
import org.jabref.logic.importer.fileformat.medline.Pagination;
import org.jabref.logic.importer.fileformat.medline.PersonalNameSubject;
import org.jabref.logic.importer.fileformat.medline.PersonalNameSubjectList;
import org.jabref.logic.importer.fileformat.medline.PubDate;
import org.jabref.logic.importer.fileformat.medline.PublicationType;
import org.jabref.logic.importer.fileformat.medline.Publisher;
import org.jabref.logic.importer.fileformat.medline.PubmedArticle;
import org.jabref.logic.importer.fileformat.medline.PubmedArticleSet;
import org.jabref.logic.importer.fileformat.medline.PubmedBookArticle;
import org.jabref.logic.importer.fileformat.medline.PubmedBookArticleSet;
import org.jabref.logic.importer.fileformat.medline.PubmedBookData;
import org.jabref.logic.importer.fileformat.medline.QualifierName;
import org.jabref.logic.importer.fileformat.medline.Section;
import org.jabref.logic.importer.fileformat.medline.Sections;
import org.jabref.logic.importer.fileformat.medline.Text;
import org.jabref.logic.util.StandardFileType;
import org.jabref.model.entry.BibEntry;
import org.jabref.model.entry.Month;
import org.jabref.model.entry.field.Field;
import org.jabref.model.entry.field.FieldFactory;
import org.jabref.model.entry.field.StandardField;
import org.jabref.model.entry.field.UnknownField;
import org.jabref.model.entry.types.StandardEntryType;
import org.jabref.model.strings.StringUtil;

import com.google.common.base.Joiner;
import jakarta.xml.bind.JAXBContext;
import jakarta.xml.bind.JAXBElement;
import jakarta.xml.bind.JAXBException;
import jakarta.xml.bind.Unmarshaller;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Importer for the Medline/Pubmed format.
 * &lt;p&gt;
 * check here for details on the format https://www.nlm.nih.gov/bsd/licensee/elements_descriptions.html
 */
<span class="fc" id="L95">public class MedlineImporter extends Importer implements Parser {</span>

<span class="fc" id="L97">    private static final Logger LOGGER = LoggerFactory.getLogger(MedlineImporter.class);</span>
    private static final String KEYWORD_SEPARATOR = &quot;; &quot;;

<span class="fc" id="L100">    private static final Locale ENGLISH = Locale.ENGLISH;</span>
    private Unmarshaller unmarshaller;

    private static String join(List&lt;String&gt; list, String string) {
<span class="fc" id="L104">        return Joiner.on(string).join(list);</span>
    }

    @Override
    public String getName() {
<span class="fc" id="L109">        return &quot;Medline/PubMed&quot;;</span>
    }

    @Override
    public StandardFileType getFileType() {
<span class="fc" id="L114">        return StandardFileType.MEDLINE;</span>
    }

    @Override
    public String getId() {
<span class="fc" id="L119">        return &quot;medline&quot;;</span>
    }

    @Override
    public String getDescription() {
<span class="fc" id="L124">        return &quot;Importer for the Medline format.&quot;;</span>
    }

    @Override
    public boolean isRecognizedFormat(BufferedReader reader) throws IOException {
        String str;
<span class="fc" id="L130">        int i = 0;</span>
<span class="fc bfc" id="L131" title="All 4 branches covered.">        while (((str = reader.readLine()) != null) &amp;&amp; (i &lt; 50)) {</span>

<span class="fc bfc" id="L133" title="All 2 branches covered.">            if (str.toLowerCase(ENGLISH).contains(&quot;&lt;pubmedarticle&gt;&quot;)</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">                    || str.toLowerCase(ENGLISH).contains(&quot;&lt;pubmedbookarticle&gt;&quot;)) {</span>
<span class="fc" id="L135">                return true;</span>
            }

<span class="fc" id="L138">            i++;</span>
        }
<span class="fc" id="L140">        return false;</span>
    }

    @Override
    public ParserResult importDatabase(BufferedReader reader) throws IOException {
<span class="fc" id="L145">        Objects.requireNonNull(reader);</span>

<span class="fc" id="L147">        List&lt;BibEntry&gt; bibItems = new ArrayList&lt;&gt;();</span>

        try {
<span class="fc" id="L150">            Object unmarshalledObject = unmarshallRoot(reader);</span>

            // check whether we have an article set, an article, a book article or a book article set
<span class="fc bfc" id="L153" title="All 2 branches covered.">            if (unmarshalledObject instanceof PubmedArticleSet) {</span>
<span class="fc" id="L154">                PubmedArticleSet articleSet = (PubmedArticleSet) unmarshalledObject;</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">                for (Object article : articleSet.getPubmedArticleOrPubmedBookArticle()) {</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">                    if (article instanceof PubmedArticle) {</span>
<span class="fc" id="L157">                        PubmedArticle currentArticle = (PubmedArticle) article;</span>
<span class="fc" id="L158">                        parseArticle(currentArticle, bibItems);</span>
                    }
<span class="fc bfc" id="L160" title="All 2 branches covered.">                    if (article instanceof PubmedBookArticle) {</span>
<span class="fc" id="L161">                        PubmedBookArticle currentArticle = (PubmedBookArticle) article;</span>
<span class="fc" id="L162">                        parseBookArticle(currentArticle, bibItems);</span>
                    }
<span class="fc" id="L164">                }</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">            } else if (unmarshalledObject instanceof PubmedArticle) {</span>
<span class="fc" id="L166">                PubmedArticle article = (PubmedArticle) unmarshalledObject;</span>
<span class="fc" id="L167">                parseArticle(article, bibItems);</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">            } else if (unmarshalledObject instanceof PubmedBookArticle) {</span>
<span class="fc" id="L169">                PubmedBookArticle currentArticle = (PubmedBookArticle) unmarshalledObject;</span>
<span class="fc" id="L170">                parseBookArticle(currentArticle, bibItems);</span>
<span class="fc" id="L171">            } else {</span>
<span class="fc" id="L172">                PubmedBookArticleSet bookArticleSet = (PubmedBookArticleSet) unmarshalledObject;</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">                for (PubmedBookArticle bookArticle : bookArticleSet.getPubmedBookArticle()) {</span>
<span class="fc" id="L174">                    parseBookArticle(bookArticle, bibItems);</span>
<span class="fc" id="L175">                }</span>
            }
<span class="fc" id="L177">        } catch (JAXBException | XMLStreamException e) {</span>
<span class="fc" id="L178">            LOGGER.debug(&quot;could not parse document&quot;, e);</span>
<span class="fc" id="L179">            return ParserResult.fromError(e);</span>
<span class="fc" id="L180">        }</span>
<span class="fc" id="L181">        return new ParserResult(bibItems);</span>
    }

    private Object unmarshallRoot(BufferedReader reader) throws JAXBException, XMLStreamException {
<span class="fc" id="L185">        initUmarshaller();</span>

<span class="fc" id="L187">        XMLInputFactory xmlInputFactory = XMLInputFactory.newFactory();</span>
<span class="fc" id="L188">        XMLStreamReader xmlStreamReader = xmlInputFactory.createXMLStreamReader(reader);</span>

        // go to the root element
<span class="fc bfc" id="L191" title="All 2 branches covered.">        while (!xmlStreamReader.isStartElement()) {</span>
<span class="fc" id="L192">            xmlStreamReader.next();</span>
        }

<span class="fc" id="L195">        return unmarshaller.unmarshal(xmlStreamReader);</span>
    }

    private void initUmarshaller() throws JAXBException {
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">        if (unmarshaller == null) {</span>
            // Lazy init because this is expensive
<span class="fc" id="L201">            JAXBContext context = JAXBContext.newInstance(&quot;org.jabref.logic.importer.fileformat.medline&quot;);</span>
<span class="fc" id="L202">            unmarshaller = context.createUnmarshaller();</span>
        }
<span class="fc" id="L204">    }</span>

    private void parseBookArticle(PubmedBookArticle currentArticle, List&lt;BibEntry&gt; bibItems) {
<span class="fc" id="L207">        Map&lt;Field, String&gt; fields = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">        if (currentArticle.getBookDocument() != null) {</span>
<span class="fc" id="L209">            BookDocument bookDocument = currentArticle.getBookDocument();</span>
<span class="fc" id="L210">            fields.put(StandardField.PMID, bookDocument.getPMID().getContent());</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">            if (bookDocument.getDateRevised() != null) {</span>
<span class="fc" id="L212">                DateRevised dateRevised = bookDocument.getDateRevised();</span>
<span class="fc" id="L213">                addDateRevised(fields, dateRevised);</span>
            }
<span class="fc bfc" id="L215" title="All 2 branches covered.">            if (bookDocument.getAbstract() != null) {</span>
<span class="fc" id="L216">                Abstract abs = bookDocument.getAbstract();</span>
<span class="fc" id="L217">                addAbstract(fields, abs);</span>
            }
<span class="fc bfc" id="L219" title="All 2 branches covered.">            if (bookDocument.getPagination() != null) {</span>
<span class="fc" id="L220">                Pagination pagination = bookDocument.getPagination();</span>
<span class="fc" id="L221">                addPagination(fields, pagination);</span>
            }
<span class="fc bfc" id="L223" title="All 2 branches covered.">            if (bookDocument.getSections() != null) {</span>
<span class="fc" id="L224">                ArrayList&lt;String&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L225">                Sections sections = bookDocument.getSections();</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">                for (Section section : sections.getSection()) {</span>
<span class="fc bfc" id="L227" title="All 2 branches covered.">                    for (Serializable content : section.getSectionTitle().getContent()) {</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">                        if (content instanceof String) {</span>
<span class="fc" id="L229">                            result.add((String) content);</span>
                        }
<span class="fc" id="L231">                    }</span>
<span class="fc" id="L232">                }</span>
<span class="fc" id="L233">                fields.put(new UnknownField(&quot;sections&quot;), join(result, &quot;; &quot;));</span>
            }
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">            if (bookDocument.getKeywordList() != null) {</span>
<span class="fc" id="L236">                addKeyWords(fields, bookDocument.getKeywordList());</span>
            }
<span class="fc bfc" id="L238" title="All 2 branches covered.">            if (bookDocument.getContributionDate() != null) {</span>
<span class="fc" id="L239">                addContributionDate(fields, bookDocument.getContributionDate());</span>
            }
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">            if (bookDocument.getPublicationType() != null) {</span>
<span class="fc" id="L242">                List&lt;String&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">                for (PublicationType type : bookDocument.getPublicationType()) {</span>
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">                    if (type.getContent() != null) {</span>
<span class="fc" id="L245">                        result.add(type.getContent());</span>
                    }
<span class="fc" id="L247">                }</span>
<span class="fc" id="L248">                fields.put(new UnknownField(&quot;pubtype&quot;), join(result, &quot;, &quot;));</span>
            }
<span class="fc bfc" id="L250" title="All 2 branches covered.">            if (bookDocument.getArticleTitle() != null) {</span>
<span class="fc" id="L251">                ArticleTitle articleTitle = bookDocument.getArticleTitle();</span>
<span class="fc" id="L252">                ArrayList&lt;String&gt; titles = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">                for (Serializable content : articleTitle.getContent()) {</span>
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">                    if (content instanceof String) {</span>
<span class="fc" id="L255">                        titles.add((String) content);</span>
                    }
<span class="fc" id="L257">                }</span>
<span class="fc" id="L258">                fields.put(new UnknownField(&quot;article&quot;), join(titles, &quot;, &quot;));</span>
            }
<span class="fc bfc" id="L260" title="All 2 branches covered.">            if (bookDocument.getBook() != null) {</span>
<span class="fc" id="L261">                addBookInformation(fields, bookDocument.getBook());</span>
            }
        }

<span class="fc bfc" id="L265" title="All 2 branches covered.">        if (currentArticle.getPubmedBookData() != null) {</span>
<span class="fc" id="L266">            PubmedBookData bookData = currentArticle.getPubmedBookData();</span>
<span class="fc" id="L267">            putIfValueNotNull(fields, StandardField.PUBSTATE, bookData.getPublicationStatus());</span>
        }

<span class="fc" id="L270">        BibEntry entry = new BibEntry(StandardEntryType.Article);</span>
<span class="fc" id="L271">        entry.setField(fields);</span>

<span class="fc" id="L273">        bibItems.add(entry);</span>
<span class="fc" id="L274">    }</span>

    private void addBookInformation(Map&lt;Field, String&gt; fields, Book book) {
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">        if (book.getPublisher() != null) {</span>
<span class="fc" id="L278">            Publisher publisher = book.getPublisher();</span>
<span class="fc" id="L279">            putIfValueNotNull(fields, new UnknownField(&quot;publocation&quot;), publisher.getPublisherLocation());</span>
<span class="fc" id="L280">            putStringFromSerializableList(fields, StandardField.PUBLISHER, publisher.getPublisherName().getContent());</span>
        }
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">        if (book.getBookTitle() != null) {</span>
<span class="fc" id="L283">            BookTitle title = book.getBookTitle();</span>
<span class="fc" id="L284">            putStringFromSerializableList(fields, StandardField.TITLE, title.getContent());</span>
        }
<span class="pc bpc" id="L286" title="1 of 2 branches missed.">        if (book.getPubDate() != null) {</span>
<span class="fc" id="L287">            addPubDate(fields, book.getPubDate());</span>
        }
<span class="pc bpc" id="L289" title="1 of 2 branches missed.">        if (book.getAuthorList() != null) {</span>
<span class="fc" id="L290">            List&lt;AuthorList&gt; authorLists = book.getAuthorList();</span>
            // authorLists size should be one
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">            if (authorLists.size() == 1) {</span>
<span class="fc bfc" id="L293" title="All 2 branches covered.">                for (AuthorList authorList : authorLists) {</span>
<span class="fc" id="L294">                    handleAuthors(fields, authorList);</span>
<span class="fc" id="L295">                }</span>
            } else {
<span class="nc" id="L297">                LOGGER.info(String.format(&quot;Size of authorlist was %s&quot;, authorLists.size()));</span>
            }
        }

<span class="fc" id="L301">        putIfValueNotNull(fields, StandardField.VOLUME, book.getVolume());</span>
<span class="fc" id="L302">        putIfValueNotNull(fields, StandardField.EDITION, book.getEdition());</span>
<span class="fc" id="L303">        putIfValueNotNull(fields, new UnknownField(&quot;medium&quot;), book.getMedium());</span>
<span class="fc" id="L304">        putIfValueNotNull(fields, new UnknownField(&quot;reportnumber&quot;), book.getReportNumber());</span>

<span class="pc bpc" id="L306" title="1 of 2 branches missed.">        if (book.getELocationID() != null) {</span>
<span class="fc bfc" id="L307" title="All 2 branches covered.">            for (ELocationID id : book.getELocationID()) {</span>
<span class="fc" id="L308">                addElocationID(fields, id);</span>
<span class="fc" id="L309">            }</span>
        }
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">        if (book.getIsbn() != null) {</span>
<span class="fc" id="L312">            fields.put(StandardField.ISBN, join(book.getIsbn(), &quot;, &quot;));</span>
        }
<span class="fc" id="L314">    }</span>

    private void putStringFromSerializableList(Map&lt;Field, String&gt; fields, Field field, List&lt;Serializable&gt; contentList) {
<span class="fc" id="L317">        StringBuilder result = new StringBuilder();</span>
<span class="fc bfc" id="L318" title="All 2 branches covered.">        for (Serializable content : contentList) {</span>
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">            if (content instanceof String) {</span>
<span class="fc" id="L320">                result.append((String) content);</span>
            }
<span class="fc" id="L322">        }</span>
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">        if (result.length() &gt; 0) {</span>
<span class="fc" id="L324">            fields.put(field, result.toString());</span>
        }
<span class="fc" id="L326">    }</span>

    private void addContributionDate(Map&lt;Field, String&gt; fields, ContributionDate contributionDate) {
<span class="pc bpc" id="L329" title="2 of 4 branches missed.">        if ((contributionDate.getDay() != null) &amp;&amp; (contributionDate.getMonth() != null)</span>
<span class="pc bpc" id="L330" title="1 of 2 branches missed.">                &amp;&amp; (contributionDate.getYear() != null)) {</span>
<span class="fc" id="L331">            String result = convertToDateFormat(contributionDate.getYear(), contributionDate.getMonth(),</span>
<span class="fc" id="L332">                    contributionDate.getDay());</span>
<span class="fc" id="L333">            fields.put(new UnknownField(&quot;contribution&quot;), result);</span>
        }
<span class="fc" id="L335">    }</span>

    private String convertToDateFormat(String year, String month, String day) {
<span class="fc" id="L338">        return String.format(&quot;%s-%s-%s&quot;, year, month, day);</span>
    }

    private void parseArticle(PubmedArticle article, List&lt;BibEntry&gt; bibItems) {
<span class="fc" id="L342">        Map&lt;Field, String&gt; fields = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L344" title="All 2 branches covered.">        if (article.getPubmedData() != null) {</span>
<span class="fc bfc" id="L345" title="All 2 branches covered.">            if (article.getMedlineCitation().getDateRevised() != null) {</span>
<span class="fc" id="L346">                DateRevised dateRevised = article.getMedlineCitation().getDateRevised();</span>
<span class="fc" id="L347">                addDateRevised(fields, dateRevised);</span>
<span class="fc" id="L348">                putIfValueNotNull(fields, StandardField.PUBSTATE, article.getPubmedData().getPublicationStatus());</span>
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">                if (article.getPubmedData().getArticleIdList() != null) {</span>
<span class="fc" id="L350">                    ArticleIdList articleIdList = article.getPubmedData().getArticleIdList();</span>
<span class="fc" id="L351">                    addArticleIdList(fields, articleIdList);</span>
                }
            }
        }
<span class="fc bfc" id="L355" title="All 2 branches covered.">        if (article.getMedlineCitation() != null) {</span>
<span class="fc" id="L356">            MedlineCitation medlineCitation = article.getMedlineCitation();</span>

<span class="fc" id="L358">            fields.put(new UnknownField(&quot;status&quot;), medlineCitation.getStatus());</span>
<span class="fc" id="L359">            DateCreated dateCreated = medlineCitation.getDateCreated();</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">            if (medlineCitation.getDateCreated() != null) {</span>
<span class="fc" id="L361">                fields.put(new UnknownField(&quot;created&quot;),</span>
<span class="fc" id="L362">                        convertToDateFormat(dateCreated.getYear(), dateCreated.getMonth(), dateCreated.getDay()));</span>
            }
<span class="fc" id="L364">            fields.put(new UnknownField(&quot;pubmodel&quot;), medlineCitation.getArticle().getPubModel());</span>

<span class="fc bfc" id="L366" title="All 2 branches covered.">            if (medlineCitation.getDateCompleted() != null) {</span>
<span class="fc" id="L367">                DateCompleted dateCompleted = medlineCitation.getDateCompleted();</span>
<span class="fc" id="L368">                fields.put(new UnknownField(&quot;completed&quot;),</span>
<span class="fc" id="L369">                        convertToDateFormat(dateCompleted.getYear(), dateCompleted.getMonth(), dateCompleted.getDay()));</span>
            }

<span class="fc" id="L372">            fields.put(StandardField.PMID, medlineCitation.getPMID().getContent());</span>
<span class="fc" id="L373">            fields.put(StandardField.OWNER, medlineCitation.getOwner());</span>

<span class="fc" id="L375">            addArticleInformation(fields, medlineCitation.getArticle().getContent());</span>

<span class="fc" id="L377">            MedlineJournalInfo medlineJournalInfo = medlineCitation.getMedlineJournalInfo();</span>
<span class="fc" id="L378">            putIfValueNotNull(fields, new UnknownField(&quot;country&quot;), medlineJournalInfo.getCountry());</span>
<span class="fc" id="L379">            putIfValueNotNull(fields, new UnknownField(&quot;journal-abbreviation&quot;), medlineJournalInfo.getMedlineTA());</span>
<span class="fc" id="L380">            putIfValueNotNull(fields, new UnknownField(&quot;nlm-id&quot;), medlineJournalInfo.getNlmUniqueID());</span>
<span class="fc" id="L381">            putIfValueNotNull(fields, new UnknownField(&quot;issn-linking&quot;), medlineJournalInfo.getISSNLinking());</span>
<span class="fc bfc" id="L382" title="All 2 branches covered.">            if (medlineCitation.getChemicalList() != null) {</span>
<span class="pc bpc" id="L383" title="1 of 2 branches missed.">                if (medlineCitation.getChemicalList().getChemical() != null) {</span>
<span class="fc" id="L384">                    addChemicals(fields, medlineCitation.getChemicalList().getChemical());</span>
                }
            }
<span class="pc bpc" id="L387" title="1 of 2 branches missed.">            if (medlineCitation.getCitationSubset() != null) {</span>
<span class="fc" id="L388">                fields.put(new UnknownField(&quot;citation-subset&quot;), join(medlineCitation.getCitationSubset(), &quot;, &quot;));</span>
            }
<span class="fc bfc" id="L390" title="All 2 branches covered.">            if (medlineCitation.getGeneSymbolList() != null) {</span>
<span class="fc" id="L391">                addGeneSymbols(fields, medlineCitation.getGeneSymbolList());</span>
            }
<span class="fc bfc" id="L393" title="All 2 branches covered.">            if (medlineCitation.getMeshHeadingList() != null) {</span>
<span class="fc" id="L394">                addMeashHeading(fields, medlineCitation.getMeshHeadingList());</span>
            }
<span class="fc" id="L396">            putIfValueNotNull(fields, new UnknownField(&quot;references&quot;), medlineCitation.getNumberOfReferences());</span>
<span class="fc bfc" id="L397" title="All 2 branches covered.">            if (medlineCitation.getPersonalNameSubjectList() != null) {</span>
<span class="fc" id="L398">                addPersonalNames(fields, medlineCitation.getPersonalNameSubjectList());</span>
            }
<span class="pc bpc" id="L400" title="1 of 2 branches missed.">            if (medlineCitation.getOtherID() != null) {</span>
<span class="fc" id="L401">                addOtherId(fields, medlineCitation.getOtherID());</span>
            }
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">            if (medlineCitation.getKeywordList() != null) {</span>
<span class="fc" id="L404">                addKeyWords(fields, medlineCitation.getKeywordList());</span>
            }
<span class="pc bpc" id="L406" title="1 of 2 branches missed.">            if (medlineCitation.getSpaceFlightMission() != null) {</span>
<span class="fc" id="L407">                fields.put(new UnknownField(&quot;space-flight-mission&quot;), join(medlineCitation.getSpaceFlightMission(), &quot;, &quot;));</span>
            }
<span class="fc bfc" id="L409" title="All 2 branches covered.">            if (medlineCitation.getInvestigatorList() != null) {</span>
<span class="fc" id="L410">                addInvestigators(fields, medlineCitation.getInvestigatorList());</span>
            }
<span class="pc bpc" id="L412" title="1 of 2 branches missed.">            if (medlineCitation.getGeneralNote() != null) {</span>
<span class="fc" id="L413">                addNotes(fields, medlineCitation.getGeneralNote());</span>
            }
        }

<span class="fc" id="L417">        BibEntry entry = new BibEntry(StandardEntryType.Article);</span>
<span class="fc" id="L418">        entry.setField(fields);</span>

<span class="fc" id="L420">        bibItems.add(entry);</span>
<span class="fc" id="L421">    }</span>

    private void addArticleIdList(Map&lt;Field, String&gt; fields, ArticleIdList articleIdList) {
<span class="fc bfc" id="L424" title="All 2 branches covered.">        for (ArticleId id : articleIdList.getArticleId()) {</span>
<span class="pc bpc" id="L425" title="1 of 2 branches missed.">            if (id.getIdType() != null) {</span>
<span class="fc bfc" id="L426" title="All 2 branches covered.">                if (&quot;pubmed&quot;.equals(id.getIdType())) {</span>
<span class="fc" id="L427">                    fields.put(StandardField.PMID, id.getContent());</span>
                } else {
<span class="fc" id="L429">                    fields.put(FieldFactory.parseField(id.getIdType()), id.getContent());</span>
                }
            }
<span class="fc" id="L432">        }</span>
<span class="fc" id="L433">    }</span>

    private void addNotes(Map&lt;Field, String&gt; fields, List&lt;GeneralNote&gt; generalNote) {
<span class="fc" id="L436">        List&lt;String&gt; notes = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L437" title="All 2 branches covered.">        for (GeneralNote note : generalNote) {</span>
<span class="pc bpc" id="L438" title="1 of 2 branches missed.">            if (note != null) {</span>
<span class="fc" id="L439">                notes.add(note.getContent());</span>
            }
<span class="fc" id="L441">        }</span>
<span class="fc" id="L442">        fields.put(StandardField.NOTE, join(notes, &quot;, &quot;));</span>
<span class="fc" id="L443">    }</span>

    private void addInvestigators(Map&lt;Field, String&gt; fields, InvestigatorList investigatorList) {
<span class="fc" id="L446">        List&lt;String&gt; investigatorNames = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L447">        List&lt;String&gt; affiliationInfos = new ArrayList&lt;&gt;();</span>
        String name;
        // add the investigators like the authors
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">        if (investigatorList.getInvestigator() != null) {</span>
<span class="fc" id="L451">            List&lt;Investigator&gt; investigators = investigatorList.getInvestigator();</span>
<span class="fc bfc" id="L452" title="All 2 branches covered.">            for (Investigator investigator : investigators) {</span>
<span class="fc" id="L453">                name = investigator.getLastName();</span>
<span class="pc bpc" id="L454" title="1 of 2 branches missed.">                if (investigator.getForeName() != null) {</span>
<span class="fc" id="L455">                    name += &quot;, &quot; + investigator.getForeName();</span>
                }
<span class="fc" id="L457">                investigatorNames.add(name);</span>

                // now add the affiliation info
<span class="pc bpc" id="L460" title="1 of 2 branches missed.">                if (investigator.getAffiliationInfo() != null) {</span>
<span class="fc bfc" id="L461" title="All 2 branches covered.">                    for (AffiliationInfo info : investigator.getAffiliationInfo()) {</span>
<span class="fc bfc" id="L462" title="All 2 branches covered.">                        for (Serializable affiliation : info.getAffiliation().getContent()) {</span>
<span class="pc bpc" id="L463" title="1 of 2 branches missed.">                            if (affiliation instanceof String) {</span>
<span class="fc" id="L464">                                affiliationInfos.add((String) affiliation);</span>
                            }
<span class="fc" id="L466">                        }</span>
<span class="fc" id="L467">                    }</span>
<span class="fc" id="L468">                    fields.put(new UnknownField(&quot;affiliation&quot;), join(affiliationInfos, &quot;, &quot;));</span>
                }
<span class="fc" id="L470">            }</span>
<span class="fc" id="L471">            fields.put(new UnknownField(&quot;investigator&quot;), join(investigatorNames, &quot; and &quot;));</span>
        }
<span class="fc" id="L473">    }</span>

    private void addKeyWords(Map&lt;Field, String&gt; fields, List&lt;KeywordList&gt; allKeywordLists) {
<span class="fc" id="L476">        List&lt;String&gt; keywordStrings = new ArrayList&lt;&gt;();</span>
        // add keywords to the list
<span class="fc bfc" id="L478" title="All 2 branches covered.">        for (KeywordList keywordList : allKeywordLists) {</span>
<span class="fc bfc" id="L479" title="All 2 branches covered.">            for (Keyword keyword : keywordList.getKeyword()) {</span>
<span class="fc bfc" id="L480" title="All 2 branches covered.">                for (Serializable content : keyword.getContent()) {</span>
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">                    if (content instanceof String) {</span>
<span class="fc" id="L482">                        keywordStrings.add((String) content);</span>
                    }
<span class="fc" id="L484">                }</span>
<span class="fc" id="L485">            }</span>
<span class="fc" id="L486">        }</span>
        // Check whether MeshHeadingList exist or not
<span class="fc bfc" id="L488" title="All 2 branches covered.">        if (fields.get(StandardField.KEYWORDS) == null) {</span>
<span class="fc" id="L489">            fields.put(StandardField.KEYWORDS, join(keywordStrings, KEYWORD_SEPARATOR));</span>
        } else {
<span class="fc bfc" id="L491" title="All 2 branches covered.">            if (keywordStrings.size() &gt; 0) {</span>
                // if it exists, combine the MeshHeading with the keywords
<span class="fc" id="L493">                String result = join(keywordStrings, &quot;; &quot;);</span>
<span class="fc" id="L494">                result = fields.get(StandardField.KEYWORDS) + KEYWORD_SEPARATOR + result;</span>
<span class="fc" id="L495">                fields.put(StandardField.KEYWORDS, result);</span>
            }
        }
<span class="fc" id="L498">    }</span>

    private void addOtherId(Map&lt;Field, String&gt; fields, List&lt;OtherID&gt; otherID) {
<span class="fc bfc" id="L501" title="All 2 branches covered.">        for (OtherID id : otherID) {</span>
<span class="pc bpc" id="L502" title="2 of 4 branches missed.">            if ((id.getSource() != null) &amp;&amp; (id.getContent() != null)) {</span>
<span class="fc" id="L503">                fields.put(FieldFactory.parseField(id.getSource()), id.getContent());</span>
            }
<span class="fc" id="L505">        }</span>
<span class="fc" id="L506">    }</span>

    private void addPersonalNames(Map&lt;Field, String&gt; fields, PersonalNameSubjectList personalNameSubjectList) {
<span class="fc bfc" id="L509" title="All 2 branches covered.">        if (fields.get(StandardField.AUTHOR) == null) {</span>
            // if no authors appear, then add the personal names as authors
<span class="fc" id="L511">            List&lt;String&gt; personalNames = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L512" title="1 of 2 branches missed.">            if (personalNameSubjectList.getPersonalNameSubject() != null) {</span>
<span class="fc" id="L513">                List&lt;PersonalNameSubject&gt; personalNameSubject = personalNameSubjectList.getPersonalNameSubject();</span>
<span class="fc bfc" id="L514" title="All 2 branches covered.">                for (PersonalNameSubject personalName : personalNameSubject) {</span>
<span class="fc" id="L515">                    String name = personalName.getLastName();</span>
<span class="pc bpc" id="L516" title="1 of 2 branches missed.">                    if (personalName.getForeName() != null) {</span>
<span class="fc" id="L517">                        name += &quot;, &quot; + personalName.getForeName();</span>
                    }
<span class="fc" id="L519">                    personalNames.add(name);</span>
<span class="fc" id="L520">                }</span>
<span class="fc" id="L521">                fields.put(StandardField.AUTHOR, join(personalNames, &quot; and &quot;));</span>
            }
        }
<span class="fc" id="L524">    }</span>

    private void addMeashHeading(Map&lt;Field, String&gt; fields, MeshHeadingList meshHeadingList) {
<span class="fc" id="L527">        ArrayList&lt;String&gt; keywords = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L528" title="All 2 branches covered.">        for (MeshHeading keyword : meshHeadingList.getMeshHeading()) {</span>
<span class="fc" id="L529">            StringBuilder result = new StringBuilder(keyword.getDescriptorName().getContent());</span>
<span class="pc bpc" id="L530" title="1 of 2 branches missed.">            if (keyword.getQualifierName() != null) {</span>
<span class="fc bfc" id="L531" title="All 2 branches covered.">                for (QualifierName qualifier : keyword.getQualifierName()) {</span>
<span class="fc" id="L532">                    result.append(&quot;, &quot;).append(qualifier.getContent());</span>
<span class="fc" id="L533">                }</span>
            }
<span class="fc" id="L535">            keywords.add(result.toString());</span>
<span class="fc" id="L536">        }</span>
<span class="fc" id="L537">        fields.put(StandardField.KEYWORDS, join(keywords, KEYWORD_SEPARATOR));</span>
<span class="fc" id="L538">    }</span>

    private void addGeneSymbols(Map&lt;Field, String&gt; fields, GeneSymbolList geneSymbolList) {
<span class="fc" id="L541">        List&lt;String&gt; geneSymbols = geneSymbolList.getGeneSymbol();</span>
<span class="fc" id="L542">        fields.put(new UnknownField(&quot;gene-symbols&quot;), join(geneSymbols, &quot;, &quot;));</span>
<span class="fc" id="L543">    }</span>

    private void addChemicals(Map&lt;Field, String&gt; fields, List&lt;Chemical&gt; chemicals) {
<span class="fc" id="L546">        List&lt;String&gt; chemicalNames = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L547" title="All 2 branches covered.">        for (Chemical chemical : chemicals) {</span>
<span class="pc bpc" id="L548" title="1 of 2 branches missed.">            if (chemical != null) {</span>
<span class="fc" id="L549">                chemicalNames.add(chemical.getNameOfSubstance().getContent());</span>
            }
<span class="fc" id="L551">        }</span>
<span class="fc" id="L552">        fields.put(new UnknownField(&quot;chemicals&quot;), join(chemicalNames, &quot;, &quot;));</span>
<span class="fc" id="L553">    }</span>

    private void addArticleInformation(Map&lt;Field, String&gt; fields, List&lt;Object&gt; content) {
<span class="fc bfc" id="L556" title="All 2 branches covered.">        for (Object object : content) {</span>
<span class="fc bfc" id="L557" title="All 2 branches covered.">            if (object instanceof Journal) {</span>
<span class="fc" id="L558">                Journal journal = (Journal) object;</span>
<span class="fc" id="L559">                putIfValueNotNull(fields, StandardField.JOURNAL, journal.getTitle());</span>

<span class="fc" id="L561">                ISSN issn = journal.getISSN();</span>
<span class="fc bfc" id="L562" title="All 2 branches covered.">                if (issn != null) {</span>
<span class="fc" id="L563">                    putIfValueNotNull(fields, StandardField.ISSN, issn.getContent());</span>
                }

<span class="fc" id="L566">                JournalIssue journalIssue = journal.getJournalIssue();</span>
<span class="fc" id="L567">                putIfValueNotNull(fields, StandardField.VOLUME, journalIssue.getVolume());</span>
<span class="fc" id="L568">                putIfValueNotNull(fields, StandardField.ISSUE, journalIssue.getIssue());</span>

<span class="fc" id="L570">                addPubDate(fields, journalIssue.getPubDate());</span>
<span class="fc bfc" id="L571" title="All 2 branches covered.">            } else if (object instanceof ArticleTitle) {</span>
<span class="fc" id="L572">                ArticleTitle articleTitle = (ArticleTitle) object;</span>
<span class="fc" id="L573">                fields.put(StandardField.TITLE, StringUtil.stripBrackets(articleTitle.getContent().toString()));</span>
<span class="fc bfc" id="L574" title="All 2 branches covered.">            } else if (object instanceof Pagination) {</span>
<span class="fc" id="L575">                Pagination pagination = (Pagination) object;</span>
<span class="fc" id="L576">                addPagination(fields, pagination);</span>
<span class="fc bfc" id="L577" title="All 2 branches covered.">            } else if (object instanceof ELocationID) {</span>
<span class="fc" id="L578">                ELocationID eLocationID = (ELocationID) object;</span>
<span class="fc" id="L579">                addElocationID(fields, eLocationID);</span>
<span class="fc bfc" id="L580" title="All 2 branches covered.">            } else if (object instanceof Abstract) {</span>
<span class="fc" id="L581">                Abstract abs = (Abstract) object;</span>
<span class="fc" id="L582">                addAbstract(fields, abs);</span>
<span class="fc bfc" id="L583" title="All 2 branches covered.">            } else if (object instanceof AuthorList) {</span>
<span class="fc" id="L584">                AuthorList authors = (AuthorList) object;</span>
<span class="fc" id="L585">                handleAuthors(fields, authors);</span>
            }
<span class="fc" id="L587">        }</span>
<span class="fc" id="L588">    }</span>

    private void addElocationID(Map&lt;Field, String&gt; fields, ELocationID eLocationID) {
<span class="fc bfc" id="L591" title="All 2 branches covered.">        if (eLocationID.getEIdType().equals(&quot;doi&quot;)) {</span>
<span class="fc" id="L592">            fields.put(StandardField.DOI, eLocationID.getContent());</span>
        }
<span class="fc bfc" id="L594" title="All 2 branches covered.">        if (eLocationID.getEIdType().equals(&quot;pii&quot;)) {</span>
<span class="fc" id="L595">            fields.put(new UnknownField(&quot;pii&quot;), eLocationID.getContent());</span>
        }
<span class="fc" id="L597">    }</span>

    private void addPubDate(Map&lt;Field, String&gt; fields, PubDate pubDate) {
<span class="fc bfc" id="L600" title="All 2 branches covered.">        if (pubDate.getYear() == null) {</span>
            // if year of the pubdate is null, the medlineDate shouldn't be null
<span class="fc" id="L602">            fields.put(StandardField.YEAR, extractYear(pubDate.getMedlineDate()));</span>
        } else {
<span class="fc" id="L604">            fields.put(StandardField.YEAR, pubDate.getYear());</span>
<span class="fc bfc" id="L605" title="All 2 branches covered.">            if (pubDate.getMonth() != null) {</span>
<span class="fc" id="L606">                Optional&lt;Month&gt; month = Month.parse(pubDate.getMonth());</span>
<span class="pc bpc" id="L607" title="1 of 2 branches missed.">                if (month.isPresent()) {</span>
<span class="fc" id="L608">                    fields.put(StandardField.MONTH, month.get().getJabRefFormat());</span>
                }
<span class="fc bfc" id="L610" title="All 2 branches covered.">            } else if (pubDate.getSeason() != null) {</span>
<span class="fc" id="L611">                fields.put(new UnknownField(&quot;season&quot;), pubDate.getSeason());</span>
            }
        }
<span class="fc" id="L614">    }</span>

    private void addAbstract(Map&lt;Field, String&gt; fields, Abstract abs) {
<span class="fc" id="L617">        putIfValueNotNull(fields, new UnknownField(&quot;copyright&quot;), abs.getCopyrightInformation());</span>
<span class="fc" id="L618">        List&lt;String&gt; abstractText = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L619" title="All 2 branches covered.">        for (AbstractText text : abs.getAbstractText()) {</span>
<span class="fc bfc" id="L620" title="All 2 branches covered.">            for (Serializable textContent : text.getContent()) {</span>
<span class="fc bfc" id="L621" title="All 2 branches covered.">                if (textContent instanceof String) {</span>
<span class="fc" id="L622">                    abstractText.add((String) textContent);</span>
                }
<span class="fc" id="L624">            }</span>
<span class="fc" id="L625">        }</span>
<span class="fc" id="L626">        fields.put(StandardField.ABSTRACT, join(abstractText, &quot; &quot;));</span>
<span class="fc" id="L627">    }</span>

    private void addPagination(Map&lt;Field, String&gt; fields, Pagination pagination) {
<span class="fc" id="L630">        String startPage = &quot;&quot;;</span>
<span class="fc" id="L631">        String endPage = &quot;&quot;;</span>
<span class="fc bfc" id="L632" title="All 2 branches covered.">        for (JAXBElement&lt;String&gt; element : pagination.getContent()) {</span>
<span class="fc bfc" id="L633" title="All 2 branches covered.">            if (&quot;MedlinePgn&quot;.equals(element.getName().getLocalPart())) {</span>
<span class="fc" id="L634">                putIfValueNotNull(fields, StandardField.PAGES, fixPageRange(element.getValue()));</span>
<span class="fc bfc" id="L635" title="All 2 branches covered.">            } else if (&quot;StartPage&quot;.equals(element.getName().getLocalPart())) {</span>
                // it could happen, that the article has only a start page
<span class="fc" id="L637">                startPage = element.getValue() + endPage;</span>
<span class="fc" id="L638">                putIfValueNotNull(fields, StandardField.PAGES, startPage);</span>
<span class="pc bpc" id="L639" title="1 of 2 branches missed.">            } else if (&quot;EndPage&quot;.equals(element.getName().getLocalPart())) {</span>
<span class="fc" id="L640">                endPage = element.getValue();</span>
                // but it should not happen, that a endpage appears without startpage
<span class="fc" id="L642">                fields.put(StandardField.PAGES, fixPageRange(startPage + &quot;-&quot; + endPage));</span>
            }
<span class="fc" id="L644">        }</span>
<span class="fc" id="L645">    }</span>

    private String extractYear(String medlineDate) {
        // The year of the medlineDate should be the first 4 digits
<span class="fc" id="L649">        return medlineDate.substring(0, 4);</span>
    }

    private void handleAuthors(Map&lt;Field, String&gt; fields, AuthorList authors) {
<span class="fc" id="L653">        List&lt;String&gt; authorNames = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L654" title="All 2 branches covered.">        for (Author author : authors.getAuthor()) {</span>
<span class="fc bfc" id="L655" title="All 2 branches covered.">            if (author.getCollectiveName() != null) {</span>
<span class="fc" id="L656">                Text collectiveNames = author.getCollectiveName();</span>
<span class="fc bfc" id="L657" title="All 2 branches covered.">                for (Serializable content : collectiveNames.getContent()) {</span>
<span class="pc bpc" id="L658" title="1 of 2 branches missed.">                    if (content instanceof String) {</span>
<span class="fc" id="L659">                        authorNames.add((String) content);</span>
                    }
<span class="fc" id="L661">                }</span>
<span class="fc" id="L662">            } else {</span>
<span class="fc" id="L663">                String authorName = author.getLastName();</span>
<span class="fc bfc" id="L664" title="All 2 branches covered.">                if (author.getForeName() != null) {</span>
<span class="fc" id="L665">                    authorName += &quot;, &quot; + author.getForeName();</span>
                }
<span class="fc" id="L667">                authorNames.add(authorName);</span>
            }
<span class="fc" id="L669">        }</span>
<span class="fc" id="L670">        fields.put(StandardField.AUTHOR, join(authorNames, &quot; and &quot;));</span>
<span class="fc" id="L671">    }</span>

    private void addDateRevised(Map&lt;Field, String&gt; fields, DateRevised dateRevised) {
<span class="pc bpc" id="L674" title="3 of 6 branches missed.">        if ((dateRevised.getDay() != null) &amp;&amp; (dateRevised.getMonth() != null) &amp;&amp; (dateRevised.getYear() != null)) {</span>
<span class="fc" id="L675">            fields.put(new UnknownField(&quot;revised&quot;),</span>
<span class="fc" id="L676">                    convertToDateFormat(dateRevised.getYear(), dateRevised.getMonth(), dateRevised.getDay()));</span>
        }
<span class="fc" id="L678">    }</span>

    private void putIfValueNotNull(Map&lt;Field, String&gt; fields, Field field, String value) {
<span class="fc bfc" id="L681" title="All 2 branches covered.">        if (value != null) {</span>
<span class="fc" id="L682">            fields.put(field, value);</span>
        }
<span class="fc" id="L684">    }</span>

    /**
     * Convert medline page ranges from short form to full form. Medline reports page ranges in a shorthand format. The last page is reported using only the digits which differ from the first page. i.e. 12345-51 refers to the actual range 12345-12351
     */
    private String fixPageRange(String pageRange) {
<span class="fc" id="L690">        int minusPos = pageRange.indexOf('-');</span>
<span class="fc bfc" id="L691" title="All 2 branches covered.">        if (minusPos &lt; 0) {</span>
<span class="fc" id="L692">            return pageRange;</span>
        }
<span class="fc" id="L694">        String startPage = pageRange.substring(0, minusPos).trim();</span>
<span class="fc" id="L695">        String endPage = pageRange.substring(minusPos + 1).trim();</span>
<span class="fc" id="L696">        int lengthOfEndPage = endPage.length();</span>
<span class="fc" id="L697">        int lengthOfStartPage = startPage.length();</span>
<span class="fc bfc" id="L698" title="All 2 branches covered.">        if (lengthOfEndPage &lt; lengthOfStartPage) {</span>
<span class="fc" id="L699">            endPage = startPage.substring(0, lengthOfStartPage - lengthOfEndPage) + endPage;</span>
        }
<span class="fc" id="L701">        return startPage + &quot;--&quot; + endPage;</span>
    }

    @Override
    public List&lt;BibEntry&gt; parseEntries(InputStream inputStream) throws ParseException {
        try {
<span class="fc" id="L707">            return importDatabase(</span>
<span class="fc" id="L708">                    new BufferedReader(new InputStreamReader(inputStream, StandardCharsets.UTF_8))).getDatabase().getEntries();</span>
<span class="nc" id="L709">        } catch (IOException e) {</span>
<span class="nc" id="L710">            LOGGER.error(e.getLocalizedMessage(), e);</span>
        }
<span class="nc" id="L712">        return Collections.emptyList();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>